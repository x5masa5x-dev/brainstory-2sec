<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brain Story 5sec</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html{height:100%;overflow:hidden}
  body{background:#0d0d1a;font-family:'Noto Sans JP','DM Sans',sans-serif;height:100%;overflow:hidden}
  button,input{font-family:inherit;-webkit-appearance:none}
  button:focus,input:focus{outline:none}
  input[type="text"]{font-size:16px!important}
  @keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  @keyframes breathe{0%,100%{opacity:.4}50%{opacity:.8}}
  @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.08)}}
  @keyframes countdown{from{width:100%}to{width:0%}}
  ::-webkit-scrollbar{width:4px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:#2a2a44;border-radius:2px}
  #root{height:100%}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const {useState,useRef,useEffect,useCallback} = React;

const SYS = `„ÅÇ„Å™„Åü„ÅØ„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Çπ„Éà„Éº„É™„Éº„ÅÆ„Ç≤„Éº„É†„Éû„Çπ„Çø„Éº„Åß„Åô„ÄÇ

ÂøÖ„Åö‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅÆ„Åø„ÅßËøîÁ≠î„ÄÇJSON‰ª•Â§ñ„ÅØÂá∫ÂäõÁ¶ÅÊ≠¢„ÄÇÁµµÊñáÂ≠ó„ÉªÁâπÊÆäË®òÂè∑„ÅØÁ¶ÅÊ≠¢„ÄÇ
{"narrative":"Â†¥Èù¢„ÅÆÊèèÂÜô","choiceA":"ÈÅ∏ÊäûËÇ¢A","choiceB":"ÈÅ∏ÊäûËÇ¢B","situation":"Áä∂Ê≥Å1Êñá","sceneNumber":1,"isEnding":false,"endingTitle":"","endingSummary":""}

# Êñá‰ΩìÔºàÊúÄÈáçË¶ÅÔºâ
- Â∞èÂ≠¶Ê†°È´òÂ≠¶Âπ¥„ÅåË™≠„ÇÅ„Çã„ÇÑ„Åï„Åó„ÅÑÊó•Êú¨Ë™û
- 1Êñá„ÅØÁü≠„Åè„ÄÇ40ÊñáÂ≠ó‰ª•ÂÜÖ
- Èõ£„Åó„ÅÑË®ÄËëâ„ÄÅÊØîÂñ©„ÅØÁ¶ÅÊ≠¢
- narrative„ÅØ3„Äú4Êñá

# ÈÅ∏ÊäûËÇ¢ÔºàÂøÖÈ†àÔºâ
- choiceA„Å®choiceB„ÅØÊØéÂõûÂøÖ„ÅöÊõ∏„Åè„Åì„Å®„ÄÇÁ©∫„Å´„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ
- ÂØæÁÖßÁöÑ„Å™2„Å§„ÅÆË°åÂãï„ÄÇ„Åù„Çå„Åû„Çå10ÊñáÂ≠ó‰ª•ÂÜÖ
- isEnding=true„ÅÆ„Å®„Åç„Å†„ÅëchoiceA=""„ÄÅchoiceB=""„Å´„Åó„Å¶„Çà„ÅÑ

# ÂÖ•Âäõ„ÅÆËß£Èáà
- choiceA/B„Å´Ëøë„ÅÑÂõûÁ≠î‚Üí„Åù„ÅÆ„Åæ„ÅæÂèçÊò†
- Ëá™Áî±„Å™ÂõûÁ≠î‚Üí„Åß„Åç„Çã„Å†„ÅëÂèçÊò†
- „Åµ„Åñ„Åë„ÅüÂõûÁ≠î‚Üí„É¶„Éº„É¢„Ç¢„ÅßÂá¶ÁêÜ
- Âç±Èô∫„ÉªÊö¥Âäõ‚ÜíÊàêÂäü„Åï„Åõ„Å™„ÅÑ

# Áâ©Ë™û
- scene 1„ÅÆÁâ©„ÇÑ‰∫∫„ÅåÂæå„ÅßÈáçË¶Å„Å´„Å™„Çã„Çà„ÅÜ„Å´‰ªïËæº„ÇÄ
- scene 2„Äú3„ÅßÊÑèÂ§ñ„Å™Â±ïÈñã
- „É¶„Éº„Ç∂„Éº„ÅÆÂà§Êñ≠„ÅåÂæå„Å´ÂΩ±Èüø„Åô„Çã
- ËâØ„ÅÑ„Åì„Å®„ÇÇÊÇ™„ÅÑ„Åì„Å®„ÇÇËµ∑„Åç„Çã

# ÁµêÊú´Ôºà5„Äú6Â†¥Èù¢Ôºâ
- sceneNumber„ÅØ1„Åã„Çâ+1„ÄÇscene 4„Åã„ÇâÂèéÊùü„ÄÇscene 5„Äú6„ÅßisEnding=true„ÄÇ6Ë∂Ö„ÅàÁ¶ÅÊ≠¢
- „Äå„ÅÇ„ÅÆÈÅ∏Êäû„Åå„Åì„Åì„Å´Áπã„Åå„Å£„Åü„Äç„Å®ÊÄù„Åà„ÇãÊßãÊàê
- endingSummary„ÅØ3Êñá`;

const SGEN = `Êù°‰ª∂Ôºö‰∏ª‰∫∫ÂÖ¨={protagonist}„ÄÅ„Ç∏„É£„É≥„É´={genre}„ÄÅÊ∞óÂàÜ={mood}

JSONÂΩ¢Âºè„ÅÆ„Åø„ÄÇÁµµÊñáÂ≠óÁ¶ÅÊ≠¢„ÄÇ„ÇÑ„Åï„Åó„ÅÑÊó•Êú¨Ë™û„ÄÇ1Êñá40ÊñáÂ≠ó‰ª•ÂÜÖ„ÄÇ
{"title":"„Çø„Ç§„Éà„É´","genre":"„Ç∏„É£„É≥„É´Áü≠Á∏Æ","setting":"2Êñá„ÅÆË®≠ÂÆö„ÄÇÁßòÂØÜ„Åã„Çø„Ç§„É†„É™„Éü„ÉÉ„Éà„ÇíÂê´„ÇÄ","firstScene":"ÊúÄÂàù„ÅÆÂ†¥Èù¢3„Äú4Êñá","choiceA":"ÊúÄÂàù„ÅÆÈÅ∏ÊäûAÔºà10ÊñáÂ≠ó‰ª•ÂÜÖÔºâ","choiceB":"ÊúÄÂàù„ÅÆÈÅ∏ÊäûBÔºà10ÊñáÂ≠ó‰ª•ÂÜÖÔºâ"}`;

const PROTAGS=[{id:"man",l:"Áî∑ÊÄß"},{id:"woman",l:"Â•≥ÊÄß"},{id:"child",l:"Â≠ê‰æõ"},{id:"other",l:"‰∫∫Èñì‰ª•Â§ñ"}];
const GENRES=[{id:"work",l:"‰ªï‰∫ã"},{id:"daily",l:"Êó•Â∏∏"},{id:"mystery",l:"„Éü„Çπ„ÉÜ„É™„Éº"},{id:"scifi",l:"SF"},{id:"fantasy",l:"„Éï„Ç°„É≥„Çø„Ç∏„Éº"},{id:"survival",l:"„Çµ„Éê„Ç§„Éê„É´"}];
const MOODS=[{id:"thrill",l:"„Éè„É©„Éè„É©"},{id:"warm",l:"„Åª„Å£„Åì„Çä"},{id:"think",l:"ËÄÉ„Åà„Åï„Åõ„Çâ„Çå„Çã"},{id:"funny",l:"Á¨ë„Åà„Çã"}];
const mf={fontFamily:"'DM Mono',monospace"};

function App(){
  const [apiKey,setApiKey]=useState(localStorage.getItem("bs5_key")||"");
  const [keyIn,setKeyIn]=useState("");
  const [phase,setPhase]=useState(apiKey?"title":"setup");
  const [sc,setSc]=useState(null);
  const [scenes,setScenes]=useState([]);
  const [uInput,setUInput]=useState("");
  const [loading,setLoading]=useState(false);
  const [hist,setHist]=useState([]);
  const [ending,setEnding]=useState(null);
  const [aLog,setALog]=useState([]);
  const [listening,setListening]=useState(false);
  const [fi,setFi]=useState(true);
  const [vh,setVh]=useState(window.innerHeight);
  const [sp,setSp]=useState("man");
  const [sg,setSg]=useState("daily");
  const [sm,setSm]=useState("thrill");
  const [gen,setGen]=useState(false);
  const [choices,setChoices]=useState(null);
  // challenge: idle|active|listening
  const [cp,setCp]=useState("idle");
  const [fast,setFast]=useState(0);
  const [total,setTotal]=useState(0);

  const iRef=useRef(null);
  const sRef=useRef(null);
  const rRef=useRef(null);
  const subRef=useRef(false);
  const ltRef=useRef(null);

  const fade=()=>{setFi(false);requestAnimationFrame(()=>requestAnimationFrame(()=>setFi(true)))};

  useEffect(()=>{
    const fn=()=>setVh(window.visualViewport?window.visualViewport.height:window.innerHeight);
    if(window.visualViewport){window.visualViewport.addEventListener("resize",fn);window.visualViewport.addEventListener("scroll",fn)}
    else window.addEventListener("resize",fn);
    fn();
    return()=>{if(window.visualViewport){window.visualViewport.removeEventListener("resize",fn);window.visualViewport.removeEventListener("scroll",fn)}else window.removeEventListener("resize",fn)};
  },[]);

  useEffect(()=>{
    if(!iRef.current)return;
    const el=iRef.current;
    const ps=()=>{setTimeout(()=>window.scrollTo(0,0),50);setTimeout(()=>window.scrollTo(0,0),300)};
    el.addEventListener("focus",ps);
    return()=>el.removeEventListener("focus",ps);
  },[phase]);

  useEffect(()=>{
    if(sRef.current&&scenes.length>0){
      const els=sRef.current.children;
      if(els.length>0)els[els.length-1].scrollIntoView({behavior:"smooth",block:"start"});
    }
  },[scenes,loading]);

  const saveKey=()=>{if(!keyIn.trim())return;localStorage.setItem("bs5_key",keyIn.trim());setApiKey(keyIn.trim());setPhase("title")};

  const killMic=useCallback(()=>{
    if(rRef.current){try{rRef.current.abort()}catch(e){}try{rRef.current.stop()}catch(e){}rRef.current.onresult=null;rRef.current.onerror=null;rRef.current.onend=null;rRef.current=null}
    setListening(false);clearTimeout(ltRef.current);
  },[]);

  const callAPI=async(system,messages)=>{
    const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey,system,messages})});
    if(!res.ok){let m="HTTP "+res.status;try{m+=": "+(await res.text()).slice(0,200)}catch(e){}throw new Error(m)}
    return await res.json();
  };

  const pJ=(raw)=>{try{return JSON.parse(raw.replace(/```json\s*/g,"").replace(/```/g,"").trim())}catch{return null}};

  const genStory=async()=>{
    setGen(true);
    const pr=SGEN.replace("{protagonist}",PROTAGS.find(p=>p.id===sp).l).replace("{genre}",GENRES.find(g=>g.id===sg).l).replace("{mood}",MOODS.find(m=>m.id===sm).l);
    try{
      const data=await callAPI(pr,[{role:"user",content:"„Çπ„Éà„Éº„É™„Éº„Çí‰Ωú„Å£„Å¶„ÄÇ"}]);
      const raw=data.content.map(c=>c.type==="text"?c.text:"").filter(Boolean).join("\n");
      const s=pJ(raw);
      if(!s)throw new Error("ÁîüÊàêÂ§±Êïó„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ");
      const scenario={id:"g"+Date.now(),title:s.title,genre:s.genre,setting:s.setting,firstScene:s.firstScene};
      setSc(scenario);
      setScenes([{type:"scene",text:scenario.firstScene,sceneNumber:0}]);
      setHist([{role:"user",content:"Ë®≠ÂÆöÔºö„Äå"+scenario.title+"„Äç\n"+scenario.setting+"\n\nÊúÄÂàù„ÅÆÂ†¥Èù¢Ôºö\n"+scenario.firstScene+"\n\nsceneNumber=1„Åã„Çâ„ÄÇ‰∫ÜËß£„Å®„Å†„ÅëÁ≠î„Åà„Å¶„ÄÇ"},{role:"assistant",content:"‰∫ÜËß£"}]);
      setChoices(s.choiceA&&s.choiceB?{a:s.choiceA,b:s.choiceB}:{a:"Ë™ø„Åπ„Çã",b:"ÊßòÂ≠ê„ÇíË¶ã„Çã"});
      setCp("idle");setALog([]);setEnding(null);setFast(0);setTotal(0);subRef.current=false;fade();setPhase("playing");
    }catch(err){alert("„Ç®„É©„Éº: "+err.message)}
    setGen(false);
  };

  // === 5sec Challenge ===
  // CRITICAL: SpeechRecognition.start() must be called synchronously
  // from the click handler with NO async/state calls before it.
  const startChallenge=()=>{
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){setCp("active");setTimeout(()=>submitChoice("ÔºàÈü≥Â£∞ÈùûÂØæÂøúÔºâ",false),100);return}

    // Create and start recognition FIRST, before any state updates
    const r=new SR();
    r.lang="ja-JP";r.interimResults=false;r.continuous=false;
    const t0=Date.now();
    let done=false;

    r.onresult=(e)=>{
      if(done)return;done=true;
      const txt=e.results[0][0].transcript;
      const sec=(Date.now()-t0)/1000;
      clearTimeout(ltRef.current);
      try{r.stop()}catch(e){}
      rRef.current=null;
      setListening(false);
      submitChoice(txt,sec<=5);
    };
    r.onerror=(e)=>{
      if(done)return;done=true;
      clearTimeout(ltRef.current);
      try{r.stop()}catch(e){}
      rRef.current=null;
      setListening(false);
      if(e.error!=="aborted")submitChoice("ÔºàËø∑„Å£„ÅüÔºâ",false);
    };
    r.onend=()=>{
      setListening(false);
      if(!done){done=true;clearTimeout(ltRef.current);rRef.current=null;submitChoice("ÔºàÊôÇÈñìÂàá„ÇåÔºâ",false)}
    };

    // START immediately in the click handler call stack
    r.start();

    // Now update state (after .start() has been called)
    rRef.current=r;
    setListening(true);
    setCp("active");

    // 5sec timeout
    ltRef.current=setTimeout(()=>{
      if(done)return;done=true;
      try{r.abort()}catch(e){}
      rRef.current=null;
      setListening(false);
      submitChoice("ÔºàÊôÇÈñìÂàá„ÇåÔºâ",false);
    },5500);
  };

  const submitChoice=async(text,wasFast)=>{
    if(subRef.current)return;
    subRef.current=true;
    setCp("idle");setUInput("");
    setTotal(t=>t+1);
    if(wasFast)setFast(f=>f+1);
    setScenes(p=>[...p,{type:"action",text}]);
    setALog(p=>[...p,text]);
    setLoading(true);setChoices(null);

    const nh=[...hist,{role:"user",content:text}];
    const th=nh.length<=14?nh:[...nh.slice(0,2),...nh.slice(-12)];
    try{
      const data=await callAPI(SYS,th);
      const raw=data.content.map(c=>c.type==="text"?c.text:"").filter(Boolean).join("\n");
      const p=pJ(raw)||{narrative:raw||"...",situation:"",sceneNumber:scenes.filter(s=>s.type==="scene").length+1,isEnding:false,choiceA:"",choiceB:""};
      setScenes(prev=>[...prev,{type:"scene",text:p.narrative,sceneNumber:p.sceneNumber,situation:p.situation}]);
      setHist([...nh,{role:"assistant",content:JSON.stringify(p)}]);
      if(p.isEnding){setEnding({title:p.endingTitle||"ÁµêÊú´",summary:p.endingSummary||""});setChoices(null)}
      else{setChoices(p.choiceA&&p.choiceB?{a:p.choiceA,b:p.choiceB}:{a:"ÈÄ≤„ÇÄ",b:"Êàª„Çã"});setCp("idle")}
    }catch(err){setScenes(prev=>[...prev,{type:"scene",text:"Ôºà„Ç®„É©„Éº: "+err.message+"Ôºâ",sceneNumber:-1}])}
    setLoading(false);subRef.current=false;
  };

  // Manual submit
  const manualMic=()=>{
    if(loading||subRef.current)return;killMic();
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR)return;
    try{
      const r=new SR();r.lang="ja-JP";r.interimResults=true;r.continuous=false;rRef.current=r;
      r.onresult=(e)=>{const t=Array.from(e.results).map(x=>x[0].transcript).join("");setUInput(t);if(e.results[e.results.length-1].isFinal){killMic();if(!subRef.current){subRef.current=true;submitChoice(t,false)}}};
      r.onerror=()=>killMic();r.onend=()=>setListening(false);
      r.start();setListening(true);
    }catch(e){}
  };

  const manualSubmit=()=>{if(!uInput.trim()||loading||subRef.current)return;subRef.current=true;killMic();submitChoice(uInput.trim(),false)};
  const onKey=(e)=>{if(e.key==="Enter"&&!e.shiftKey&&!e.nativeEvent.isComposing){e.preventDefault();manualSubmit()}};

  const ctr={height:vh,background:"linear-gradient(180deg,#0d0d1a 0%,#141428 50%,#0d0d1a 100%)",display:"flex",justifyContent:"center",alignItems:"flex-start",padding:"8px 8px 0",overflow:"hidden"};
  const card={width:"100%",maxWidth:500,height:"100%",background:"linear-gradient(165deg,#181830 0%,#12122a 100%)",borderRadius:"20px 20px 0 0",border:"1px solid #2a2a44",borderBottom:"none",padding:"16px 16px 0",opacity:fi?1:0,transform:fi?"translateY(0)":"translateY(12px)",transition:"opacity 0.4s,transform 0.4s",display:"flex",flexDirection:"column",overflow:"hidden"};
  const chip=(sel)=>({padding:"10px 16px",border:"none",borderRadius:10,background:sel?"#64dfdf22":"transparent",outline:sel?"1.5px solid #64dfdf66":"1.5px solid #2a2a42",color:sel?"#64dfdf":"#7a7a8a",fontSize:15,fontWeight:sel?600:400,cursor:"pointer"});

  return(
    <div style={ctr}>
      <div style={card}>

        {/* SETUP */}
        {phase==="setup"&&(
          <div style={{textAlign:"center",animation:"slideUp 0.6s ease",overflowY:"auto",flex:1,paddingBottom:20}}>
            <div style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:4,marginBottom:16}}>STILLNOVA STUDIO</div>
            <h1 style={{fontSize:28,color:"#e8e8f0",fontWeight:700,marginBottom:24}}>Brain Story 5sec</h1>
            <div style={{background:"#1a1a2e",borderRadius:16,padding:20,border:"1px solid #2a2a42",textAlign:"left"}}>
              <div style={{...mf,fontSize:12,color:"#64dfdf",marginBottom:10}}>API KEY</div>
              <p style={{fontSize:14,color:"#7a7a8a",lineHeight:1.7,marginBottom:12}}>Claude API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
              <input type="password" value={keyIn} onChange={e=>setKeyIn(e.target.value)} placeholder="sk-ant-..."
                style={{width:"100%",padding:"14px 16px",background:"#12122a",border:"1.5px solid #2a2a42",borderRadius:12,color:"#d4d4e0",fontSize:16,marginBottom:12}}/>
              <button onClick={saveKey} style={{width:"100%",padding:16,border:"none",borderRadius:14,background:keyIn.trim()?"linear-gradient(135deg,#64dfdf,#4ab8b8)":"#2a2a42",color:keyIn.trim()?"#0d0d1a":"#5a5a6a",fontSize:16,fontWeight:700,cursor:keyIn.trim()?"pointer":"default"}}>„ÅØ„Åò„ÇÅ„Çã</button>
            </div>
          </div>
        )}

        {/* TITLE */}
        {phase==="title"&&(
          <div style={{textAlign:"center",animation:"slideUp 0.6s ease",overflowY:"auto",flex:1,paddingBottom:20}}>
            <div style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:4,marginBottom:10}}>STILLNOVA STUDIO</div>
            <h1 style={{fontSize:28,color:"#e8e8f0",fontWeight:700,marginBottom:2}}>Brain Story</h1>
            <div style={{...mf,fontSize:22,color:"#ffd166",marginBottom:14,letterSpacing:2}}>5<span style={{fontSize:14,verticalAlign:"super"}}>sec</span></div>

            <div style={{background:"#1a1a2e",borderRadius:16,padding:"14px",marginBottom:8,border:"1px solid #2a2a42",textAlign:"left"}}>
              <div style={{...mf,fontSize:12,color:"#64dfdf",marginBottom:8}}>‰∏ª‰∫∫ÂÖ¨</div>
              <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                {PROTAGS.map(p=><button key={p.id} onClick={()=>setSp(p.id)} style={chip(sp===p.id)}>{p.l}</button>)}
              </div>
            </div>
            <div style={{background:"#1a1a2e",borderRadius:16,padding:"14px",marginBottom:8,border:"1px solid #2a2a42",textAlign:"left"}}>
              <div style={{...mf,fontSize:12,color:"#64dfdf",marginBottom:8}}>„Ç∏„É£„É≥„É´</div>
              <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                {GENRES.map(g=><button key={g.id} onClick={()=>setSg(g.id)} style={chip(sg===g.id)}>{g.l}</button>)}
              </div>
            </div>
            <div style={{background:"#1a1a2e",borderRadius:16,padding:"14px",marginBottom:14,border:"1px solid #2a2a42",textAlign:"left"}}>
              <div style={{...mf,fontSize:12,color:"#64dfdf",marginBottom:8}}>Ê∞óÂàÜ</div>
              <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
                {MOODS.map(m=><button key={m.id} onClick={()=>setSm(m.id)} style={chip(sm===m.id)}>{m.l}</button>)}
              </div>
            </div>

            <button onClick={genStory} disabled={gen}
              style={{width:"100%",padding:16,border:"none",borderRadius:14,background:gen?"#2a2a42":"linear-gradient(135deg,#ffd166,#ffb347)",color:gen?"#5a5a6a":"#0d0d1a",fontSize:17,fontWeight:700,cursor:gen?"default":"pointer",marginBottom:8}}>
              {gen?"ÁîüÊàê‰∏≠...":"Áâ©Ë™û„Çí„ÅØ„Åò„ÇÅ„Çã"}
            </button>
            <p style={{fontSize:13,color:"#5a5a6a",marginBottom:4}}>ÊØéÂõûAI„ÅåÈÅï„ÅÜÁâ©Ë™û„Çí‰Ωú„Çä„Åæ„Åô</p>
            <button onClick={()=>{localStorage.removeItem("bs5_key");setApiKey("");setPhase("setup")}} style={{background:"none",border:"none",color:"#3a3a52",fontSize:12,cursor:"pointer"}}>API„Ç≠„Éº„ÇíÂ§âÊõ¥</button>
          </div>
        )}

        {/* PLAYING */}
        {phase==="playing"&&sc&&(
          <>
            <div style={{marginBottom:8,flexShrink:0,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <span style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:2}}>{sc.genre} ‚Äî {sc.title}</span>
              <span style={{...mf,fontSize:12,color:"#5a5a6a"}}>SCENE {scenes.filter(s=>s.type==="scene").length}</span>
            </div>

            <div ref={sRef} style={{flex:1,overflowY:"auto",marginBottom:8,paddingRight:4,minHeight:0}}>
              {scenes.map((s,i)=>(
                <div key={i} style={{marginBottom:14,animation:i===scenes.length-1?"slideUp 0.4s ease":"none"}}>
                  {s.type==="scene"?(
                    <div>
                      {s.situation&&<div style={{fontSize:13,color:"#64dfdf88",marginBottom:4,...mf}}>{s.situation}</div>}
                      <p style={{fontSize:17,color:"#e0e0ec",lineHeight:1.9,whiteSpace:"pre-wrap"}}>{s.text}</p>
                    </div>
                  ):(
                    <div style={{padding:"10px 14px",marginLeft:16,background:"#64dfdf10",border:"1px solid #64dfdf33",borderRadius:12}}>
                      <p style={{fontSize:16,color:"#e8e8f0",lineHeight:1.6}}>{s.text}</p>
                    </div>
                  )}
                </div>
              ))}
              {loading&&(
                <div style={{padding:"12px 0",display:"flex",alignItems:"center",gap:8}}>
                  <div style={{display:"flex",gap:4}}>
                    {[0,1,2].map(i=><div key={i} style={{width:7,height:7,borderRadius:"50%",background:"#64dfdf",animation:`breathe 1.2s ${i*0.3}s infinite`}}/>)}
                  </div>
                  <span style={{fontSize:14,color:"#5a5a6a"}}>Â±ïÈñã‰∏≠...</span>
                </div>
              )}
            </div>

            {/* Bottom */}
            {!ending?(
              <div style={{flexShrink:0,paddingBottom:8}}>

                {/* 5sec challenge button */}
                {choices&&!loading&&cp==="idle"&&(
                  <button onClick={startChallenge}
                    style={{width:"100%",padding:14,border:"none",borderRadius:14,background:"linear-gradient(135deg,#ffd166,#ffb347)",color:"#0d0d1a",fontSize:17,fontWeight:700,cursor:"pointer",marginBottom:8,letterSpacing:1}}>
                    5Áßí„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ
                  </button>
                )}

                {/* Active challenge: choices shown + listening */}
                {cp==="active"&&choices&&(
                  <div style={{animation:"slideUp 0.2s ease",marginBottom:8}}>
                    <div style={{display:"flex",gap:8,marginBottom:6}}>
                      <div style={{flex:1,padding:14,background:"#1a1a2e",border:"1.5px solid #64dfdf44",borderRadius:12,textAlign:"center"}}>
                        <span style={{fontSize:12,color:"#64dfdf88",...mf}}>A</span>
                        <p style={{fontSize:17,color:"#e8e8f0",fontWeight:600,marginTop:4}}>{choices.a}</p>
                      </div>
                      <div style={{flex:1,padding:14,background:"#1a1a2e",border:"1.5px solid #ffd16644",borderRadius:12,textAlign:"center"}}>
                        <span style={{fontSize:12,color:"#ffd16688",...mf}}>B</span>
                        <p style={{fontSize:17,color:"#e8e8f0",fontWeight:600,marginTop:4}}>{choices.b}</p>
                      </div>
                    </div>
                    <div style={{height:5,background:"#2a2a42",borderRadius:3,overflow:"hidden",marginBottom:6}}>
                      <div style={{height:"100%",background:"linear-gradient(90deg,#ffd166,#ff4757)",animation:"countdown 5s linear forwards",borderRadius:3}}/>
                    </div>
                    <div style={{textAlign:"center"}}>
                      <span style={{fontSize:22,animation:"pulse 0.6s infinite"}}>üé§</span>
                      <p style={{fontSize:15,color:"#ffd166",fontWeight:600,...mf,marginTop:2}}>Â£∞„ÅßÁ≠î„Åà„Å¶ÔºÅAÔºü BÔºü Ëá™Áî±ÂõûÁ≠î„ÇÇOKÔºÅ</p>
                    </div>
                  </div>
                )}

                {/* Manual input (when not in active challenge) */}
                {cp!=="active"&&!loading&&(
                  <div style={{display:"flex",gap:6,alignItems:"center"}}>
                    <button onClick={listening?killMic:manualMic} disabled={loading}
                      style={{width:44,height:44,border:"none",borderRadius:12,background:listening?"linear-gradient(135deg,#ff4757,#ff6b6b)":"#1e1e32",color:listening?"#fff":"#6a6a7a",fontSize:18,cursor:"pointer",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",opacity:loading?.4:1,animation:listening?"pulse 1s infinite":"none"}}>üé§</button>
                    <input ref={iRef} type="text" value={uInput} onChange={e=>setUInput(e.target.value)} onKeyDown={onKey}
                      placeholder="Ëá™Áî±„Å´ÂÖ•Âäõ„ÇÇOK" disabled={loading}
                      style={{flex:1,padding:"10px 14px",background:"#1a1a2e",border:"1.5px solid #2a2a42",borderRadius:12,color:"#d4d4e0",fontSize:16,lineHeight:1.4,opacity:loading?.4:1}}/>
                    <button onClick={manualSubmit} disabled={!uInput.trim()||loading}
                      style={{padding:"10px 14px",border:"none",borderRadius:12,background:uInput.trim()&&!loading?"linear-gradient(135deg,#64dfdf,#4ab8b8)":"#2a2a42",color:uInput.trim()?"#0d0d1a":"#5a5a6a",fontSize:15,fontWeight:700,cursor:uInput.trim()?"pointer":"default",flexShrink:0,height:44}}>‚Üí</button>
                  </div>
                )}
              </div>
            ):(
              <div style={{flexShrink:0,animation:"slideUp 0.5s ease",paddingBottom:8}}>
                <div style={{background:"#1a1a2e",borderRadius:14,padding:14,border:"1px solid #64dfdf33",marginBottom:10}}>
                  <div style={{...mf,fontSize:11,color:"#64dfdf",letterSpacing:3,marginBottom:6}}>ENDING</div>
                  <div style={{fontSize:20,color:"#e8e8f0",fontWeight:700,marginBottom:8,lineHeight:1.4}}>{ending.title}</div>
                  <p style={{fontSize:15,color:"#a0a0b0",lineHeight:1.8}}>{ending.summary}</p>
                  {total>0&&(
                    <div style={{marginTop:10,padding:"8px 12px",background:"#12122a",borderRadius:10,textAlign:"center"}}>
                      <span style={{...mf,fontSize:15,color:"#ffd166"}}>Âç≥Êñ≠ {fast}/{total}</span>
                    </div>
                  )}
                </div>
                <div style={{display:"flex",gap:8}}>
                  <button onClick={()=>{killMic();fade();setPhase("ending")}} style={{flex:1,padding:14,border:"none",borderRadius:14,background:"linear-gradient(135deg,#64dfdf,#4ab8b8)",color:"#0d0d1a",fontSize:15,fontWeight:700,cursor:"pointer"}}>ÊåØ„ÇäËøî„Çä</button>
                  <button onClick={()=>{killMic();fade();setPhase("title")}} style={{flex:1,padding:14,border:"1.5px solid #3a3a52",borderRadius:14,background:"transparent",color:"#8a8a9a",fontSize:15,cursor:"pointer"}}>Ê¨°„ÅÆÁâ©Ë™û</button>
                </div>
              </div>
            )}
          </>
        )}

        {/* ENDING */}
        {phase==="ending"&&ending&&sc&&(
          <div style={{animation:"slideUp 0.6s ease",overflowY:"auto",flex:1,paddingBottom:20}}>
            <div style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:3,marginBottom:20,textAlign:"center"}}>ENDING</div>
            <div style={{fontSize:24,color:"#e8e8f0",fontWeight:700,marginBottom:16,lineHeight:1.4,textAlign:"center"}}>{ending.title}</div>
            <p style={{fontSize:16,color:"#a0a0b0",lineHeight:2,marginBottom:16}}>{ending.summary}</p>

            {total>0&&(
              <div style={{background:"#1a1a2e",borderRadius:14,padding:16,marginBottom:16,border:"1px solid #ffd16633",textAlign:"center"}}>
                <div style={{...mf,fontSize:12,color:"#ffd166",marginBottom:8}}>5SEC CHALLENGE</div>
                <div style={{fontSize:36,color:"#ffd166",fontWeight:700,...mf}}>{fast}/{total}</div>
                <p style={{fontSize:14,color:"#7a7a8a",marginTop:4}}>Âõû„ÅÆÂç≥Êñ≠„Å´ÊàêÂäü</p>
              </div>
            )}

            <div style={{background:"#1a1a2e",borderRadius:14,padding:16,marginBottom:14,border:"1px solid #2a2a42",maxHeight:350,overflowY:"auto"}}>
              <div style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:2,marginBottom:12}}>FULL STORY</div>
              <p style={{fontSize:15,color:"#8a8a9a",lineHeight:1.8,marginBottom:10,whiteSpace:"pre-wrap"}}>{sc.firstScene}</p>
              {scenes.slice(1).map((s,i)=>(
                <div key={i} style={{marginBottom:10}}>
                  {s.type==="action"?(
                    <div style={{padding:"6px 10px",marginLeft:12,background:"#64dfdf08",border:"1px solid #64dfdf22",borderRadius:8}}>
                      <span style={{fontSize:14,color:"#c4c4d0"}}>{s.text}</span>
                    </div>
                  ):(
                    <p style={{fontSize:14,color:"#8a8a9a",lineHeight:1.8,whiteSpace:"pre-wrap"}}>{s.text}</p>
                  )}
                </div>
              ))}
            </div>

            <button onClick={()=>{fade();setPhase("title")}} style={{width:"100%",padding:16,border:"none",borderRadius:14,background:"linear-gradient(135deg,#ffd166,#ffb347)",color:"#0d0d1a",fontSize:17,fontWeight:700,cursor:"pointer",marginBottom:8}}>Êñ∞„Åó„ÅÑÁâ©Ë™û„Çí„ÅØ„Åò„ÇÅ„Çã</button>
          </div>
        )}

      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
