<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brain Story 2sec</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;700&family=Playfair+Display:ital,wght@0,700;1,600&family=Noto+Serif+JP:wght@500;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { height: 100%; overflow: hidden; }
  body { background: #0d0d1a; font-family: 'DM Sans', sans-serif; height: 100%; overflow: hidden; -webkit-overflow-scrolling: touch; }
  button, textarea, input { font-family: inherit; -webkit-appearance: none; }
  textarea:focus, button:focus, input:focus { outline: none; }
  input[type="text"] { font-size: 16px !important; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes breathe { 0%,100% { opacity: 0.4; } 50% { opacity: 0.8; } }
  @keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.05); } }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #2a2a44; border-radius: 2px; }
  #root { height: 100%; }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// ============================================================
// SYSTEM PROMPT â€” å…¨é¢æ”¹å–„ç‰ˆ
// ============================================================
const SYS = `ã‚ãªãŸã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç”±ãªè¡Œå‹•å®£è¨€ã«å¿œã˜ã¦ç‰©èªã‚’é€²ã‚ã¦ãã ã•ã„ã€‚

å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚JSONä»¥å¤–ã¯ä¸€åˆ‡å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚
çµµæ–‡å­—ã‚„ç‰¹æ®Šè¨˜å·ã¯ä½¿ã‚ãšã€é€šå¸¸ã®æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
{"narrative":"æ¬¡ã®å ´é¢ã®æå†™","situation":"ä»Šã®çŠ¶æ³ã‚’1æ–‡ã§è¦ç´„","sceneNumber":1,"isEnding":false,"endingTitle":"","endingSummary":""}

# å ´é¢æå†™ã®ãƒ«ãƒ¼ãƒ«
- narrativeã¯2ã€œ4æ–‡ã€‚çŸ­ãã¦ã‚‚å¯†åº¦ã®é«˜ã„æå†™
- æ–‡ä½“ã¯ä¹¾ã„ãŸãƒˆãƒ¼ãƒ³ã§ã€‚æ¯”å–©ã‚’1ã¤å…¥ã‚Œã‚‹ã“ã¨ã€‚æ„Ÿæƒ…ã‚’ç›´æ¥æ›¸ã‹ãšã€å‹•ä½œã‚„é¢¨æ™¯ã§è¡¨ç¾ã™ã‚‹
- ã‚»ãƒªãƒ•ã¯å®Ÿéš›ã«äººãŒè¨€ã„ãã†ãªã€å°‘ã—ä¸å®Œå…¨ã§ç”Ÿã€…ã—ã„æ—¥æœ¬èªã§æ›¸ã
- å ´é¢ã«ã¯å¿…ãš2ã€œ3å€‹ã®å…·ä½“çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ»äººç‰©ãƒ»éŸ³ãƒ»åŒ‚ã„ã‚’å«ã‚ã‚‹ã“ã¨

# å•ã„ã‹ã‘ã®ãƒ«ãƒ¼ãƒ«ï¼ˆæœ€é‡è¦ï¼‰
- narrativeã®æœ€å¾Œã¯å¿…ãšã€ŒAã™ã‚‹ã‹Bã™ã‚‹ã‹ã€ã®äºŒæŠã€ã‚‚ã—ãã¯ã€ŒXã‚’ã©ã†ã™ã‚‹ï¼Ÿã€ã¨ã„ã†å…·ä½“çš„è¡Œå‹•ã®å•ã„ã§çµ‚ãˆã‚‹
- è‰¯ã„ä¾‹ï¼šã€Œéµã‚’ä½¿ã£ã¦é–‹ã‘ã‚‹ã‹ã€ãƒãƒƒã‚¯ã™ã‚‹ã‹ã€‚ã€ã€Œç›¸æ‰‹ã«åå‰ã‚’èãã‹ã€å…ˆã«ã“ã¡ã‚‰ã‹ã‚‰åä¹—ã‚‹ã‹ã€‚ã€ã€Œã“ã®æ‰‹ç´™ã‚’èª­ã‚€ã‹ã€ãã®ã¾ã¾æ£šã«æˆ»ã™ã‹ã€‚ã€
- çµ¶å¯¾ã«ç¦æ­¢ï¼šã€Œã©ã†ä¹—ã‚Šåˆ‡ã‚‹ï¼Ÿã€ã€Œã©ã‚“ãªé¸æŠã‚’ã™ã‚‹ï¼Ÿã€ã€Œæ¬¡ã®ä¸€æ‰‹ã¯ï¼Ÿã€ãªã©ã®æŠ½è±¡çš„ãƒ»ä¿¯ç°çš„ãªå•ã„
- çµ¶å¯¾ã«ç¦æ­¢ï¼šå•ã„ã‹ã‘ãªã—ã§çŠ¶æ³æå†™ã ã‘ã§çµ‚ã‚ã‚‹ã“ã¨
- isEnding=trueã®å ´åˆã®ã¿å•ã„ã‹ã‘ä¸è¦

# ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®è§£é‡ˆ
- çœŸé¢ç›®: ãã®ã¾ã¾åæ˜ 
- æ›–æ˜§ãƒ»çŸ­ã„: ä¸»äººå…¬ãŒå°‘ã—è¿·ã„ã¤ã¤ã‚‚è¡Œå‹•ã™ã‚‹æå†™ã«ã—ã¦é€²ã‚ã‚‹
- ãµã–ã‘ãŸ: ãƒ¦ãƒ¼ãƒ¢ã‚¢ã§å‡¦ç†ã€‚ç‰©èªã¯å£Šã•ãªã„
- æ„å‘³ä¸æ˜: ä¸»äººå…¬ãŒã¼ã‚“ã‚„ã‚Šã—ãŸæå†™ã«ã—ã¦å…ƒã®è»Œé“ã«æˆ»ã™
- å±é™ºãƒ»æš´åŠ›: çµ¶å¯¾ã«æˆåŠŸã•ã›ãªã„ã€‚æ­¢ã‚ã‚‰ã‚Œã‚‹ç­‰ã§å›é¿
- ç¾å®Ÿé›¢ã‚Œ: æƒ³åƒã™ã‚‹ã ã‘ã®æå†™ã«ã—ã¦ç¾å®Ÿã«æˆ»ã™

# ç‰©èªã®æ§‹é€ ï¼ˆä¼ç·šã¨å›åã‚’é‡è¦–ï¼‰
- scene 1ã§ä½•æ°—ãªãç™»å ´ã—ãŸäººç‰©ãƒ»ç‰©ãƒ»æƒ…å ±ãŒã€å¾Œã®sceneã§é‡è¦ãªæ„å‘³ã‚’æŒã¤ã‚ˆã†ã«ã™ã‚‹ã“ã¨
- scene 2ã€œ3ã§äºˆæƒ³å¤–ã®å±•é–‹ã‚’å…¥ã‚Œã‚‹ï¼ˆéš ã•ã‚Œã¦ã„ãŸäº‹å®Ÿã€æ„å¤–ãªäººç‰©ã®é–¢ä¸ã€çŠ¶æ³ã®æ€¥å¤‰ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»ã®åˆ¤æ–­ãŒå¾Œã®sceneã§çµæœã¨ã—ã¦ç¾ã‚Œã‚‹ã“ã¨ï¼ˆè‰¯ãã‚‚æ‚ªãã‚‚ï¼‰
- ç·Šå¼µã¨ç·©å’Œã®æ³¢ã‚’ä½œã‚‹ã€‚ãƒˆãƒ©ãƒ–ãƒ«é€£ç¶šç¦æ­¢ã€‚ã†ã¾ãã„ãå ´é¢ã‚„ãƒ›ãƒƒã¨ã™ã‚‹ç¬é–“ã‚‚å…¥ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ¤æ–­ãŒè‰¯ã„çµæœã‚’ã‚‚ãŸã‚‰ã—ãŸå ´é¢ã‚’æœ€ä½1å›ã¯å…¥ã‚Œã‚‹

# åæŸã¨çµæœ«ï¼ˆ5ã€œ6å ´é¢ã§å®Œçµï¼‰
- sceneNumberã¯1ã‹ã‚‰æ¯å›+1
- scene 3ã€œ4ã‹ã‚‰åæŸé–‹å§‹ã€‚scene 5ã€œ6ã§isEnding=trueã€‚6è¶…ãˆç¦æ­¢
- çµæœ«ã§ã¯ã€Œæœ€åˆã®ã‚ã®åˆ¤æ–­ãŒã“ã“ã«ç¹‹ãŒã£ãŸã®ã‹ã€ã¨æ„Ÿã˜ã‚‰ã‚Œã‚‹æ§‹æˆã«ã™ã‚‹
- çµæœ«ãƒˆãƒ¼ãƒ³ã¯ç‰©èªã«åˆã‚ã›ã¦å¤šæ§˜ã«ï¼ˆãªã‚‹ã»ã©/æ„Ÿå‹•/ã»ã£ã“ã‚Š/çˆ½å¿«/åˆ‡ãªã„/ãƒ¦ãƒ¼ãƒ¢ã‚¢ï¼‰
- endingTitleã¯è±¡å¾´çš„ãªçŸ­ã„ã‚¿ã‚¤ãƒˆãƒ«
- endingSummaryã¯3ã€œ4æ–‡ï¼šç‰©èªã®æŒ¯ã‚Šè¿”ã‚Šã¨ã€Œã‚ã®ã¨ãã®åˆ¤æ–­ãŒã“ã†å½±éŸ¿ã—ãŸã€ã¨ã„ã†å› æœã®è§£èª¬ã€‚æ¬¡å›ã¸ã®ãƒ’ãƒ³ãƒˆ`;

// ============================================================
// STORY GENERATION PROMPT
// ============================================================
const STORY_GEN_PROMPT = `ä»¥ä¸‹ã®æ¡ä»¶ã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®è¨­å®šã‚’1ã¤ä½œã£ã¦ãã ã•ã„ã€‚

æ¡ä»¶ï¼š
- ä¸»äººå…¬ã‚¿ã‚¤ãƒ—: {protagonist}
- ã‚¸ãƒ£ãƒ³ãƒ«: {genre}
- æ°—åˆ†: {mood}

å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚JSONä»¥å¤–ã¯ä¸€åˆ‡å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚
çµµæ–‡å­—ã‚„ç‰¹æ®Šè¨˜å·ã¯ä½¿ã‚ãšã€é€šå¸¸ã®æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
{"title":"ç‰©èªã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆçŸ­ãï¼‰","genre":"ã‚¸ãƒ£ãƒ³ãƒ«ã®çŸ­ã„è¡¨è¨˜","setting":"2ã€œ3æ–‡ã®è¨­å®šèª¬æ˜ã€‚ä¸»äººå…¬ã®çŠ¶æ³ã€éš ã•ã‚ŒãŸç§˜å¯†ã‚„è‘›è—¤ã®ç¨®ã‚’å«ã‚ã‚‹","firstScene":"æœ€åˆã®å ´é¢æå†™ã€‚å…·ä½“çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ2ã€œ3å€‹ã‚’å«ã‚ã€æœ€å¾Œã¯ã€ŒAã™ã‚‹ã‹Bã™ã‚‹ã‹ã€ã®å…·ä½“çš„ãªäºŒæŠã§çµ‚ãˆã‚‹"}

é‡è¦ï¼š
- settingã«ã¯å¿…ãšã€Œã¾ã èª°ã‚‚çŸ¥ã‚‰ãªã„äº‹å®Ÿã€ã€Œéš ã‚ŒãŸå¯¾ç«‹ã€ã€Œã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆã€ã®ã©ã‚Œã‹ã‚’ä»•è¾¼ã‚€ã“ã¨
- firstSceneã¯3ã€œ4æ–‡ã€‚äº”æ„Ÿã«è¨´ãˆã‚‹æå†™ã§å§‹ã‚ã€æœ€å¾Œã«å…·ä½“çš„ãªäºŒæŠã§çµ‚ãˆã‚‹
- ã‚ã‚ŠããŸã‚Šãªè¨­å®šã¯é¿ã‘ã‚‹ã€‚èª­è€…ãŒã€ŒãŠã£ã€ã¨æ€ã†æ„å¤–ãªçµ„ã¿åˆã‚ã›ã«ã™ã‚‹`;

const PROTAGONISTS = [
  { id: "man", label: "ç”·æ€§", icon: "M" },
  { id: "woman", label: "å¥³æ€§", icon: "F" },
  { id: "child", label: "å­ä¾›", icon: "C" },
  { id: "nonhuman", label: "äººé–“ä»¥å¤–", icon: "?" },
];

const GENRES = [
  { id: "work", label: "ä»•äº‹" },
  { id: "daily", label: "æ—¥å¸¸" },
  { id: "mystery", label: "ãƒŸã‚¹ãƒ†ãƒªãƒ¼" },
  { id: "scifi", label: "SF" },
  { id: "fantasy", label: "ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼" },
  { id: "survival", label: "ã‚µãƒã‚¤ãƒãƒ«" },
];

const MOODS = [
  { id: "thrill", label: "ãƒãƒ©ãƒãƒ©" },
  { id: "warm", label: "ã»ã£ã“ã‚Š" },
  { id: "think", label: "è€ƒãˆã•ã›ã‚‰ã‚Œã‚‹" },
  { id: "funny", label: "ç¬‘ãˆã‚‹" },
];

const tf = { fontFamily: "'Playfair Display','Noto Serif JP',serif" };
const mf = { fontFamily: "'DM Mono',monospace" };

function App() {
  const [apiKey, setApiKey] = useState(localStorage.getItem("bs2_key") || "");
  const [keyInput, setKeyInput] = useState("");
  const [phase, setPhase] = useState(apiKey ? "title" : "setup");
  const [scenario, setScenario] = useState(null);
  const [scenes, setScenes] = useState([]);
  const [userInput, setUserInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [history, setHistory] = useState([]);
  const [ending, setEnding] = useState(null);
  const [actionLog, setActionLog] = useState([]);
  const [isListening, setIsListening] = useState(false);
  const [fadeIn, setFadeIn] = useState(true);
  const [viewH, setViewH] = useState(window.innerHeight);
  // Story generation
  const [selProtag, setSelProtag] = useState("man");
  const [selGenre, setSelGenre] = useState("work");
  const [selMood, setSelMood] = useState("thrill");
  const [isGenerating, setIsGenerating] = useState(false);

  const inputRef = useRef(null);
  const scrollRef = useRef(null);
  const recRef = useRef(null);
  const submittingRef = useRef(false);

  const fade = () => { setFadeIn(false); requestAnimationFrame(() => requestAnimationFrame(() => setFadeIn(true))); };

  useEffect(() => {
    const onResize = () => {
      const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      setViewH(vh);
    };
    if (window.visualViewport) {
      window.visualViewport.addEventListener("resize", onResize);
      window.visualViewport.addEventListener("scroll", onResize);
    } else { window.addEventListener("resize", onResize); }
    onResize();
    return () => {
      if (window.visualViewport) {
        window.visualViewport.removeEventListener("resize", onResize);
        window.visualViewport.removeEventListener("scroll", onResize);
      } else { window.removeEventListener("resize", onResize); }
    };
  }, []);

  useEffect(() => {
    if (!inputRef.current) return;
    const el = inputRef.current;
    const preventScroll = () => {
      setTimeout(() => { window.scrollTo(0, 0); document.body.scrollTop = 0; document.documentElement.scrollTop = 0; }, 50);
      setTimeout(() => { window.scrollTo(0, 0); }, 300);
    };
    el.addEventListener("focus", preventScroll);
    return () => el.removeEventListener("focus", preventScroll);
  }, [phase]);

  useEffect(() => {
    if (scrollRef.current && scenes.length > 0) {
      const els = scrollRef.current.children;
      if (els.length > 0) els[els.length - 1].scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }, [scenes, isLoading]);

  const saveKey = () => {
    if (!keyInput.trim()) return;
    localStorage.setItem("bs2_key", keyInput.trim());
    setApiKey(keyInput.trim());
    setPhase("title");
  };

  const killMic = useCallback(() => {
    if (recRef.current) {
      try { recRef.current.abort(); } catch(e) {}
      try { recRef.current.stop(); } catch(e) {}
      recRef.current.onresult = null;
      recRef.current.onerror = null;
      recRef.current.onend = null;
      recRef.current = null;
    }
    setIsListening(false);
  }, []);

  const startListening = () => {
    if (isLoading || submittingRef.current) return;
    killMic();
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { setUserInput("ï¼ˆéŸ³å£°å…¥åŠ›éå¯¾å¿œï¼‰"); return; }
    try {
      const r = new SR();
      r.lang = "ja-JP"; r.interimResults = true; r.continuous = false;
      recRef.current = r;
      r.onresult = (e) => {
        const t = Array.from(e.results).map(x => x[0].transcript).join("");
        setUserInput(t);
        if (e.results[e.results.length - 1].isFinal) {
          killMic();
          if (!submittingRef.current) {
            submittingRef.current = true;
            setTimeout(() => doSubmit(t), 150);
          }
        }
      };
      r.onerror = (e) => { killMic(); if (e.error !== "aborted") setUserInput("ï¼ˆéŸ³å£°ã‚¨ãƒ©ãƒ¼: " + e.error + "ï¼‰"); };
      r.onend = () => setIsListening(false);
      r.start(); setIsListening(true);
    } catch (err) { setUserInput("ï¼ˆéŸ³å£°ã‚¨ãƒ©ãƒ¼: " + err.message + "ï¼‰"); }
  };

  // API call helper
  const callAPI = async (system, messages) => {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ apiKey, system, messages })
    });
    if (!res.ok) {
      let msg = "HTTP " + res.status;
      try { msg += ": " + (await res.text()).slice(0, 200); } catch(e) {}
      throw new Error(msg);
    }
    return await res.json();
  };

  // Generate story from selections
  const generateStory = async () => {
    setIsGenerating(true);
    const prompt = STORY_GEN_PROMPT
      .replace("{protagonist}", PROTAGONISTS.find(p => p.id === selProtag).label)
      .replace("{genre}", GENRES.find(g => g.id === selGenre).label)
      .replace("{mood}", MOODS.find(m => m.id === selMood).label);
    try {
      const data = await callAPI(prompt, [{ role: "user", content: "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚" }]);
      const raw = data.content.map(c => c.type === "text" ? c.text : "").filter(Boolean).join("\n");
      const cleaned = raw.replace(/```json\s*/g, "").replace(/```/g, "").trim();
      const s = JSON.parse(cleaned);
      const sc = { id: "gen_" + Date.now(), title: s.title, genre: s.genre, setting: s.setting, firstScene: s.firstScene };
      setScenario(sc);
      setScenes([{ type: "scene", text: sc.firstScene, sceneNumber: 0 }]);
      setHistory([
        { role: "user", content: "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¨­å®šï¼šã€Œ" + sc.title + "ã€\n" + sc.setting + "\n\næœ€åˆã®å ´é¢ï¼š\n" + sc.firstScene + "\n\nsceneNumber=1ã‹ã‚‰é–‹å§‹ã€‚äº†è§£ã¨ã ã‘ç­”ãˆã¦ã€‚" },
        { role: "assistant", content: "äº†è§£" }
      ]);
      setActionLog([]); setEnding(null); submittingRef.current = false; fade(); setPhase("playing");
    } catch (err) {
      alert("ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + err.message);
    }
    setIsGenerating(false);
  };

  const doSubmit = async (text) => {
    if (!text || isLoading) { submittingRef.current = false; return; }
    killMic();
    setUserInput("");
    setScenes(p => [...p, { type: "action", text }]);
    setActionLog(p => [...p, text]);
    setIsLoading(true);

    const nh = [...history, { role: "user", content: text }];
    const th = nh.length <= 14 ? nh : [...nh.slice(0, 2), ...nh.slice(-12)];

    try {
      const data = await callAPI(SYS, th);
      const raw = data.content.map(c => c.type === "text" ? c.text : "").filter(Boolean).join("\n");
      let p;
      try {
        p = JSON.parse(raw.replace(/```json\s*/g, "").replace(/```/g, "").trim());
      } catch {
        p = { narrative: raw || "...", situation: "", sceneNumber: scenes.filter(s => s.type === "scene").length + 1, isEnding: false };
      }
      setScenes(prev => [...prev, { type: "scene", text: p.narrative, sceneNumber: p.sceneNumber, situation: p.situation }]);
      setHistory([...nh, { role: "assistant", content: JSON.stringify(p) }]);
      if (p.isEnding) setEnding({ title: p.endingTitle || "çµæœ«", summary: p.endingSummary || "" });
    } catch (err) {
      setScenes(prev => [...prev, { type: "scene", text: "ï¼ˆã‚¨ãƒ©ãƒ¼: " + err.message + "ï¼‰", sceneNumber: -1 }]);
    }
    setIsLoading(false);
    submittingRef.current = false;
  };

  const submitAction = () => {
    if (!userInput.trim() || isLoading || submittingRef.current) return;
    submittingRef.current = true;
    killMic();
    doSubmit(userInput.trim());
  };

  const onKey = (e) => {
    if (e.key === "Enter" && !e.shiftKey && !e.nativeEvent.isComposing) { e.preventDefault(); submitAction(); }
  };

  const ctr = {
    height: viewH,
    background: "linear-gradient(180deg,#0d0d1a 0%,#141428 50%,#0d0d1a 100%)",
    display: "flex", justifyContent: "center", alignItems: "flex-start",
    padding: "12px 12px 0", overflow: "hidden",
  };
  const card = {
    width: "100%", maxWidth: 480, height: "100%",
    background: "linear-gradient(165deg,#181830 0%,#12122a 100%)",
    borderRadius: "24px 24px 0 0", border: "1px solid #2a2a44", borderBottom: "none",
    boxShadow: "0 20px 60px #00000066",
    padding: "20px 18px 0",
    opacity: fadeIn ? 1 : 0, transform: fadeIn ? "translateY(0)" : "translateY(12px)",
    transition: "opacity 0.4s,transform 0.4s",
    display: "flex", flexDirection: "column", overflow: "hidden",
  };

  const chipStyle = (selected) => ({
    padding: "8px 14px", border: "none", borderRadius: 10,
    background: selected ? "#64dfdf22" : "transparent",
    outline: selected ? "1.5px solid #64dfdf66" : "1.5px solid #2a2a42",
    color: selected ? "#64dfdf" : "#6a6a7a",
    fontSize: 13, cursor: "pointer", transition: "all 0.15s",
  });

  return (
    <div style={ctr}>
      <div style={card}>

        {/* SETUP */}
        {phase === "setup" && (
          <div style={{ textAlign: "center", animation: "slideUp 0.6s ease", overflowY: "auto", flex: 1, paddingBottom: 20 }}>
            <div style={{ ...mf, fontSize: 11, color: "#64dfdf", letterSpacing: 4, marginBottom: 16 }}>STILLNOVA STUDIO</div>
            <h1 style={{ ...tf, fontSize: 32, color: "#e8e8f0", marginBottom: 24 }}>Brain Story 2sec</h1>
            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: 20, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 11, color: "#64dfdf", marginBottom: 10 }}>API KEY</div>
              <p style={{ fontSize: 12, color: "#6a6a7a", lineHeight: 1.7, marginBottom: 12 }}>
                Claude APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã“ã®ç«¯æœ«ã®ã¿ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
              </p>
              <input type="password" value={keyInput} onChange={e => setKeyInput(e.target.value)} placeholder="sk-ant-..."
                style={{ width: "100%", padding: "12px 16px", background: "#12122a", border: "1.5px solid #2a2a42", borderRadius: 12, color: "#d4d4e0", fontSize: 16, marginBottom: 12 }}
              />
              <button onClick={saveKey} style={{ width: "100%", padding: 14, border: "none", borderRadius: 14, background: keyInput.trim() ? "linear-gradient(135deg,#64dfdf,#4ab8b8)" : "#2a2a42", color: keyInput.trim() ? "#0d0d1a" : "#5a5a6a", fontSize: 15, fontWeight: 700, cursor: keyInput.trim() ? "pointer" : "default" }}>
                ã¯ã˜ã‚ã‚‹
              </button>
            </div>
          </div>
        )}

        {/* TITLE â€” ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆ */}
        {phase === "title" && (
          <div style={{ textAlign: "center", animation: "slideUp 0.6s ease", overflowY: "auto", flex: 1, paddingBottom: 20 }}>
            <div style={{ ...mf, fontSize: 11, color: "#64dfdf", letterSpacing: 4, marginBottom: 12 }}>STILLNOVA STUDIO</div>
            <h1 style={{ ...tf, fontSize: 32, color: "#e8e8f0", lineHeight: 1.3, marginBottom: 4 }}>Brain Story</h1>
            <div style={{ ...mf, fontSize: 20, color: "#64dfdf", marginBottom: 16, letterSpacing: 2 }}>2<span style={{ fontSize: 13, verticalAlign: "super" }}>sec</span></div>

            {/* ä¸»äººå…¬ */}
            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: "16px 16px", marginBottom: 10, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 11, color: "#64dfdf", marginBottom: 10 }}>ä¸»äººå…¬</div>
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                {PROTAGONISTS.map(p => (
                  <button key={p.id} onClick={() => setSelProtag(p.id)} style={chipStyle(selProtag === p.id)}>{p.label}</button>
                ))}
              </div>
            </div>

            {/* ã‚¸ãƒ£ãƒ³ãƒ« */}
            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: "16px 16px", marginBottom: 10, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 11, color: "#64dfdf", marginBottom: 10 }}>ã‚¸ãƒ£ãƒ³ãƒ«</div>
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                {GENRES.map(g => (
                  <button key={g.id} onClick={() => setSelGenre(g.id)} style={chipStyle(selGenre === g.id)}>{g.label}</button>
                ))}
              </div>
            </div>

            {/* æ°—åˆ† */}
            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: "16px 16px", marginBottom: 16, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 11, color: "#64dfdf", marginBottom: 10 }}>æ°—åˆ†</div>
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                {MOODS.map(m => (
                  <button key={m.id} onClick={() => setSelMood(m.id)} style={chipStyle(selMood === m.id)}>{m.label}</button>
                ))}
              </div>
            </div>

            {/* ç”Ÿæˆãƒœã‚¿ãƒ³ */}
            <button
              onClick={generateStory}
              disabled={isGenerating}
              style={{
                width: "100%", padding: 16, border: "none", borderRadius: 14,
                background: isGenerating ? "#2a2a42" : "linear-gradient(135deg,#64dfdf,#4ab8b8)",
                color: isGenerating ? "#5a5a6a" : "#0d0d1a",
                fontSize: 16, fontWeight: 700, cursor: isGenerating ? "default" : "pointer",
                letterSpacing: 1, marginBottom: 10,
              }}
            >
              {isGenerating ? "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆä¸­..." : "ç‰©èªã‚’ã¯ã˜ã‚ã‚‹"}
            </button>

            <p style={{ fontSize: 11, color: "#4a4a5a", marginBottom: 6 }}>AIãŒæ¯å›é•ã†ç‰©èªã‚’ç”Ÿæˆã—ã¾ã™</p>
            <button onClick={() => { localStorage.removeItem("bs2_key"); setApiKey(""); setPhase("setup"); }} style={{ background: "none", border: "none", color: "#3a3a52", fontSize: 11, cursor: "pointer" }}>APIã‚­ãƒ¼ã‚’å¤‰æ›´</button>
          </div>
        )}

        {/* PLAYING */}
        {phase === "playing" && scenario && (
          <>
            <div style={{ marginBottom: 10, flexShrink: 0, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ ...mf, fontSize: 11, color: "#64dfdf", letterSpacing: 3 }}>{scenario.genre} â€” {scenario.title}</span>
              <span style={{ ...mf, fontSize: 11, color: "#5a5a6a" }}>SCENE {scenes.filter(s => s.type === "scene").length}</span>
            </div>

            <div ref={scrollRef} style={{ flex: 1, overflowY: "auto", marginBottom: 10, paddingRight: 4, minHeight: 0 }}>
              {scenes.map((s, i) => (
                <div key={i} style={{ marginBottom: 16, animation: i === scenes.length - 1 ? "slideUp 0.5s ease" : "none" }}>
                  {s.type === "scene" ? (
                    <div>
                      {s.situation && <div style={{ fontSize: 11, color: "#64dfdf88", marginBottom: 6, ...mf }}>{s.situation}</div>}
                      <p style={{ fontSize: 14, color: "#d4d4e0", lineHeight: 2, whiteSpace: "pre-wrap" }}>{s.text}</p>
                    </div>
                  ) : (
                    <div style={{ padding: "10px 16px", marginLeft: 24, background: "linear-gradient(135deg,#64dfdf12,#64dfdf08)", border: "1px solid #64dfdf33", borderRadius: 12 }}>
                      <span style={{ fontSize: 11, color: "#64dfdf88", ...mf }}>ã‚ãªãŸï¼š</span>
                      <p style={{ fontSize: 14, color: "#e8e8f0", lineHeight: 1.7, marginTop: 4 }}>{s.text}</p>
                    </div>
                  )}
                </div>
              ))}
              {isLoading && (
                <div style={{ padding: "12px 0", display: "flex", alignItems: "center", gap: 8 }}>
                  <div style={{ display: "flex", gap: 4 }}>
                    {[0,1,2].map(i => <div key={i} style={{ width: 6, height: 6, borderRadius: "50%", background: "#64dfdf", animation: `breathe 1.2s ${i*0.3}s infinite` }} />)}
                  </div>
                  <span style={{ fontSize: 12, color: "#5a5a6a" }}>ç‰©èªãŒå±•é–‹ä¸­...</span>
                </div>
              )}
            </div>

            {!ending ? (
              <div style={{ flexShrink: 0, paddingBottom: 8 }}>
                <div style={{ display: "flex", gap: 8, alignItems: "flex-end" }}>
                  <button onClick={isListening ? killMic : startListening} disabled={isLoading || submittingRef.current}
                    style={{ width: 48, height: 44, border: "none", borderRadius: 14, background: isListening ? "linear-gradient(135deg,#ff4757,#ff6b6b)" : "linear-gradient(135deg,#2a2a42,#1e1e32)", color: isListening ? "#fff" : "#8a8a9a", fontSize: 20, cursor: isLoading ? "default" : "pointer", flexShrink: 0, display: "flex", alignItems: "center", justifyContent: "center", opacity: isLoading ? 0.4 : 1, animation: isListening ? "pulse 1s infinite" : "none" }}>
                    ğŸ¤
                  </button>
                  <input ref={inputRef} type="text" value={userInput} onChange={e => setUserInput(e.target.value)} onKeyDown={onKey}
                    placeholder={isListening ? "èãå–ã‚Šä¸­..." : "è¡Œå‹•ã‚’å…¥åŠ› or ğŸ¤"} disabled={isLoading}
                    style={{ flex: 1, padding: "10px 14px", background: "#1a1a2e", border: isListening ? "1.5px solid #ff475766" : "1.5px solid #2a2a42", borderRadius: 14, color: "#d4d4e0", fontSize: 16, lineHeight: 1.5, opacity: isLoading ? 0.4 : 1, WebkitAppearance: "none" }}
                  />
                  <button onClick={submitAction} disabled={!userInput.trim() || isLoading || submittingRef.current}
                    style={{ padding: "10px 16px", border: "none", borderRadius: 14, background: userInput.trim() && !isLoading ? "linear-gradient(135deg,#64dfdf,#4ab8b8)" : "#2a2a42", color: userInput.trim() && !isLoading ? "#0d0d1a" : "#5a5a6a", fontSize: 14, fontWeight: 700, cursor: userInput.trim() && !isLoading ? "pointer" : "default", flexShrink: 0, height: 44 }}>â†’</button>
                </div>
              </div>
            ) : (
              <div style={{ flexShrink: 0, animation: "slideUp 0.5s ease", paddingBottom: 8 }}>
                <div style={{ background: "#1a1a2e", borderRadius: 16, padding: 16, border: "1px solid #64dfdf33", marginBottom: 10 }}>
                  <div style={{ ...mf, fontSize: 10, color: "#64dfdf", letterSpacing: 3, marginBottom: 6 }}>ENDING</div>
                  <div style={{ ...tf, fontSize: 18, color: "#e8e8f0", marginBottom: 8, lineHeight: 1.4 }}>{ending.title}</div>
                  <p style={{ fontSize: 13, color: "#a0a0b0", lineHeight: 1.8 }}>{ending.summary}</p>
                </div>
                <div style={{ display: "flex", gap: 8 }}>
                  <button onClick={() => { killMic(); fade(); setPhase("ending"); }} style={{ flex: 1, padding: 12, border: "none", borderRadius: 14, background: "linear-gradient(135deg,#64dfdf,#4ab8b8)", color: "#0d0d1a", fontSize: 14, fontWeight: 700, cursor: "pointer" }}>æŒ¯ã‚Šè¿”ã‚Š</button>
                  <button onClick={() => { killMic(); fade(); setPhase("title"); }} style={{ flex: 1, padding: 12, border: "1.5px solid #3a3a52", borderRadius: 14, background: "transparent", color: "#8a8a9a", fontSize: 14, cursor: "pointer" }}>åˆ¥ã®ç‰©èªã¸</button>
                </div>
              </div>
            )}
          </>
        )}

        {/* ENDING */}
        {phase === "ending" && ending && scenario && (
          <div style={{ animation: "slideUp 0.6s ease", overflowY: "auto", flex: 1, paddingBottom: 20 }}>
            <div style={{ ...mf, fontSize: 11, color: "#64dfdf", letterSpacing: 3, marginBottom: 24, textAlign: "center" }}>ENDING</div>
            <div style={{ ...tf, fontSize: 26, color: "#e8e8f0", marginBottom: 20, lineHeight: 1.4, textAlign: "center" }}>{ending.title}</div>
            <p style={{ fontSize: 15, color: "#a0a0b0", lineHeight: 2, marginBottom: 20, textAlign: "left" }}>{ending.summary}</p>

            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: 18, marginBottom: 16, border: "1px solid #2a2a42", textAlign: "left", maxHeight: 400, overflowY: "auto" }}>
              <div style={{ ...mf, fontSize: 11, color: "#64dfdf", letterSpacing: 2, marginBottom: 14 }}>FULL STORY</div>
              <p style={{ fontSize: 13, color: "#8a8a9a", lineHeight: 1.9, marginBottom: 12, whiteSpace: "pre-wrap" }}>{scenario.firstScene}</p>
              {scenes.slice(1).map((s, i) => (
                <div key={i} style={{ marginBottom: 12 }}>
                  {s.type === "action" ? (
                    <div style={{ padding: "8px 12px", marginLeft: 16, background: "#64dfdf08", border: "1px solid #64dfdf22", borderRadius: 10 }}>
                      <span style={{ fontSize: 11, color: "#64dfdf88", ...mf }}>â–¸ </span>
                      <span style={{ fontSize: 13, color: "#c4c4d0" }}>{s.text}</span>
                    </div>
                  ) : (
                    <p style={{ fontSize: 13, color: "#8a8a9a", lineHeight: 1.9, whiteSpace: "pre-wrap" }}>{s.text}</p>
                  )}
                </div>
              ))}
            </div>

            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: 18, marginBottom: 24, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 11, color: "#ffd166", letterSpacing: 2, marginBottom: 12 }}>YOUR ACTIONS</div>
              {actionLog.map((a, i) => (
                <div key={i} style={{ display: "flex", gap: 10, padding: "8px 0", borderBottom: i < actionLog.length - 1 ? "1px solid #22223a" : "none" }}>
                  <span style={{ ...mf, fontSize: 11, color: "#5a5a6a", width: 20, flexShrink: 0 }}>{i + 1}</span>
                  <span style={{ fontSize: 13, color: "#a0a0b0", lineHeight: 1.6 }}>{a}</span>
                </div>
              ))}
            </div>

            <button onClick={() => { fade(); setPhase("title"); }} style={{ width: "100%", padding: 16, border: "none", borderRadius: 14, background: "linear-gradient(135deg,#64dfdf,#4ab8b8)", color: "#0d0d1a", fontSize: 16, fontWeight: 700, cursor: "pointer", letterSpacing: 1, marginBottom: 8 }}>æ–°ã—ã„ç‰©èªã‚’ã¯ã˜ã‚ã‚‹</button>
            <p style={{ fontSize: 11, color: "#5a5a6a", textAlign: "center" }}>æ¡ä»¶ã‚’å¤‰ãˆã‚Œã°å…¨ãé•ã†ç‰©èªãŒç”Ÿã¾ã‚Œã¾ã™</p>
          </div>
        )}

      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
