<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brain Story 2sec</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { height: 100%; overflow: hidden; }
  body { background: #0d0d1a; font-family: 'Noto Sans JP', 'DM Sans', sans-serif; height: 100%; overflow: hidden; }
  button, input { font-family: inherit; -webkit-appearance: none; }
  button:focus, input:focus { outline: none; }
  input[type="text"] { font-size: 16px !important; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes breathe { 0%,100% { opacity: 0.4; } 50% { opacity: 0.8; } }
  @keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.08); } }
  @keyframes countdown { from { width: 100%; } to { width: 0%; } }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #2a2a44; border-radius: 2px; }
  #root { height: 100%; }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// ============================================================
// SYSTEM PROMPT ‚Äî „Ç∑„É≥„Éó„É´Êñá‰Ωì + ‰∫åÊäû + ‰ºèÁ∑öÂõûÂèé
// ============================================================
const SYS = `„ÅÇ„Å™„Åü„ÅØ„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Çπ„Éà„Éº„É™„Éº„ÅÆ„Ç≤„Éº„É†„Éû„Çπ„Çø„Éº„Åß„Åô„ÄÇ

ÂøÖ„Åö‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅÆ„Åø„ÅßËøîÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇJSON‰ª•Â§ñ„ÅØÂá∫ÂäõÁ¶ÅÊ≠¢„ÄÇ
ÁµµÊñáÂ≠ó„ÉªÁâπÊÆäË®òÂè∑„ÅØÁ¶ÅÊ≠¢„ÄÇÊôÆÈÄö„ÅÆÊó•Êú¨Ë™û„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åø„ÄÇ
{"narrative":"Â†¥Èù¢„ÅÆÊèèÂÜô","choiceA":"ÈÅ∏ÊäûËÇ¢AÔºàÁü≠„ÅèÔºâ","choiceB":"ÈÅ∏ÊäûËÇ¢BÔºàÁü≠„ÅèÔºâ","situation":"Áä∂Ê≥Å„Çí1Êñá„Åß","sceneNumber":1,"isEnding":false,"endingTitle":"","endingSummary":""}

# Êñá‰Ωì„É´„Éº„É´ÔºàÊúÄÈáçË¶ÅÔºâ
- Â∞èÂ≠¶Ê†°È´òÂ≠¶Âπ¥„Åß„ÇÇË™≠„ÇÅ„Çã„ÄÅ„ÇÑ„Åï„Åó„ÅÑÊó•Êú¨Ë™û„ÅßÊõ∏„Åè
- 1Êñá„ÅØÁü≠„Åè„ÄÇÈï∑„Åè„Å¶„ÇÇ40ÊñáÂ≠ó‰ª•ÂÜÖ
- Èõ£„Åó„ÅÑË®ÄËëâ„ÇÑÊØîÂñ©„ÅØ‰Ωø„Çè„Å™„ÅÑ
- „Äå„Äú„ÅÆ„Çà„ÅÜ„Å´„Äç„Äå„Åæ„Çã„Åß„Äú„Äç„ÅØÁ¶ÅÊ≠¢
- ÂÖ∑‰ΩìÁöÑ„Å´Êõ∏„Åè„ÄÇ‰Ωï„ÅåË¶ã„Åà„Å¶„ÄÅ‰Ωï„ÅåËÅû„Åì„Åà„Å¶„ÄÅ‰Ωï„ÅåËµ∑„Åç„Å¶„ÅÑ„Çã„Åã
- narrative„ÅØ3„Äú4Êñá„ÄÇÁä∂Ê≥Å„Åå„Åô„Åê„Çè„Åã„ÇãÊèèÂÜô

# ÈÅ∏ÊäûËÇ¢„É´„Éº„É´
- choiceA„Å®choiceB„ÅØÂøÖ„ÅöÂØæÁÖßÁöÑ„Å™2„Å§„ÅÆË°åÂãï
- „Åù„Çå„Åû„Çå10ÊñáÂ≠ó‰ª•ÂÜÖ„ÅÆÁü≠„ÅÑ„Éï„É¨„Éº„Ç∫
- ËâØ„ÅÑ‰æãÔºö„ÄåÊ≠£Áõ¥„Å´Ë©±„Åô„Äç„Å®„ÄåÈªô„Å£„Å¶„Åä„Åè„Äç„ÄÅ„ÄåÂè≥„ÅÆÈÅì„Äç„Å®„ÄåÂ∑¶„ÅÆÈÅì„Äç„ÄÅ„ÄåÈõªË©±„Åô„Çã„Äç„Å®„Äå„É°„Éº„É´„Åô„Çã„Äç
- isEnding=true„ÅÆÂ†¥Âêà„ÅØchoiceA=""„ÄÅchoiceB=""

# „É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„ÅÆËß£Èáà
- choiceA„ÅãchoiceB„Å´Ëøë„ÅÑÂõûÁ≠î: „Åù„ÅÆ„Åæ„ÅæÂèçÊò†
- „Åù„Çå‰ª•Â§ñ„ÅÆËá™Áî±„Å™ÂõûÁ≠î: „Åß„Åç„Çã„Å†„ÅëÂèçÊò†„Åó„Å¶Áâ©Ë™û„Å´ÁµÑ„ÅøËæº„ÇÄ
- „Åµ„Åñ„Åë„ÅüÂõûÁ≠î: „É¶„Éº„É¢„Ç¢„ÅßÂá¶ÁêÜ„Åó„Å¶ÈÄ≤„ÇÅ„Çã
- Âç±Èô∫„ÉªÊö¥Âäõ: ÊàêÂäü„Åï„Åõ„Å™„ÅÑ

# Áâ©Ë™û„ÅÆÊßãÈÄ†
- scene 1„ÅßÂá∫„Å¶„Åç„ÅüÁâ©„ÇÑ‰∫∫„Åå„ÄÅÂæå„ÅßÈáçË¶Å„Å´„Å™„Çã„Çà„ÅÜ„Å´‰ªïËæº„ÇÄ
- scene 2„Äú3„Åß„Äå„Åà„Å£„Äç„Å®ÊÄù„ÅÜÂ±ïÈñã„ÇíÂÖ•„Çå„Çã
- „É¶„Éº„Ç∂„Éº„ÅÆÈÅéÂéª„ÅÆÂà§Êñ≠„ÅåÂæå„ÅÆÂ†¥Èù¢„ÅßÁµêÊûú„Å®„Åó„Å¶Âá∫„Çã
- ËâØ„ÅÑ„Åì„Å®„ÇÇÊÇ™„ÅÑ„Åì„Å®„ÇÇËµ∑„Åç„Çã„ÄÇÊÇ™„ÅÑ„Åì„Å®„Å∞„Åã„ÇäÁ∂ö„Åë„Å™„ÅÑ

# ÁµêÊú´Ôºà5„Äú6Â†¥Èù¢„ÅßÂÆåÁµêÔºâ
- sceneNumber„ÅØ1„Åã„Çâ+1
- scene 4„Åã„ÇâÂèéÊùü„ÄÇscene 5„Äú6„ÅßisEnding=true„ÄÇ6Ë∂Ö„ÅàÁ¶ÅÊ≠¢
- ÁµêÊú´„Åß„ÄåÊúÄÂàù„ÅÆ„ÅÇ„ÅÆÈÅ∏Êäû„Åå„Åì„Åì„Å´Áπã„Åå„Å£„Åü„Çì„Å†„Äç„Å®ÊÄù„Åà„ÇãÊßãÊàê„Å´„Åô„Çã
- endingSummary„ÅØ3ÊñáÔºöÁâ©Ë™û„ÅÆÊåØ„ÇäËøî„Çä„ÄÅÂà§Êñ≠„ÅÆÂõ†Êûú„ÄÅ„Å≤„Å®„Åì„Å®ÊÑüÊÉ≥`;

// ============================================================
// STORY GENERATION
// ============================================================
const STORY_GEN = `‰ª•‰∏ã„ÅÆÊù°‰ª∂„Åß„Çπ„Éà„Éº„É™„Éº„ÅÆË®≠ÂÆö„Çí‰Ωú„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

Êù°‰ª∂Ôºö‰∏ª‰∫∫ÂÖ¨={protagonist}„ÄÅ„Ç∏„É£„É≥„É´={genre}„ÄÅÊ∞óÂàÜ={mood}

JSONÂΩ¢Âºè„ÅÆ„Åø„ÅßËøîÁ≠î„ÄÇÁµµÊñáÂ≠óÁ¶ÅÊ≠¢„ÄÇ„ÇÑ„Åï„Åó„ÅÑÊó•Êú¨Ë™û„Åß„ÄÇ
{"title":"„Çø„Ç§„Éà„É´ÔºàÁü≠„ÅèÔºâ","genre":"„Ç∏„É£„É≥„É´Áü≠Á∏Æ","setting":"2Êñá„ÅÆË®≠ÂÆö„ÄÇÁßòÂØÜ„ÇÑ„Çø„Ç§„É†„É™„Éü„ÉÉ„Éà„ÇíÂê´„ÇÅ„Çã","firstScene":"ÊúÄÂàù„ÅÆÂ†¥Èù¢„ÄÇ3„Äú4Êñá„ÄÇ„ÇÑ„Åï„Åó„ÅÑÊó•Êú¨Ë™û„ÄÇÊúÄÂæå„ÅØÁä∂Ê≥Å„ÅÆË™¨Êòé„ÅßÁµÇ„Åà„Çã","choiceA":"ÊúÄÂàù„ÅÆÈÅ∏ÊäûËÇ¢AÔºà10ÊñáÂ≠ó‰ª•ÂÜÖÔºâ","choiceB":"ÊúÄÂàù„ÅÆÈÅ∏ÊäûËÇ¢BÔºà10ÊñáÂ≠ó‰ª•ÂÜÖÔºâ"}

Ê≥®ÊÑèÔºöÂ∞èÂ≠¶Ê†°È´òÂ≠¶Âπ¥„ÅåË™≠„ÇÅ„ÇãÊñáÁ´†„ÅßÊõ∏„Åè„ÄÇÊØîÂñ©Á¶ÅÊ≠¢„ÄÇ1Êñá40ÊñáÂ≠ó‰ª•ÂÜÖ„ÄÇ`;

const PROTAGS = [
  { id: "man", label: "Áî∑ÊÄß" }, { id: "woman", label: "Â•≥ÊÄß" },
  { id: "child", label: "Â≠ê‰æõ" }, { id: "nonhuman", label: "‰∫∫Èñì‰ª•Â§ñ" },
];
const GENRES = [
  { id: "work", label: "‰ªï‰∫ã" }, { id: "daily", label: "Êó•Â∏∏" },
  { id: "mystery", label: "„Éü„Çπ„ÉÜ„É™„Éº" }, { id: "scifi", label: "SF" },
  { id: "fantasy", label: "„Éï„Ç°„É≥„Çø„Ç∏„Éº" }, { id: "survival", label: "„Çµ„Éê„Ç§„Éê„É´" },
];
const MOODS = [
  { id: "thrill", label: "„Éè„É©„Éè„É©" }, { id: "warm", label: "„Åª„Å£„Åì„Çä" },
  { id: "think", label: "ËÄÉ„Åà„Åï„Åõ„Çâ„Çå„Çã" }, { id: "funny", label: "Á¨ë„Åà„Çã" },
];

const mf = { fontFamily: "'DM Mono',monospace" };

function App() {
  const [apiKey, setApiKey] = useState(localStorage.getItem("bs2_key") || "");
  const [keyInput, setKeyInput] = useState("");
  const [phase, setPhase] = useState(apiKey ? "title" : "setup");
  const [scenario, setScenario] = useState(null);
  const [scenes, setScenes] = useState([]);
  const [userInput, setUserInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [history, setHistory] = useState([]);
  const [ending, setEnding] = useState(null);
  const [actionLog, setActionLog] = useState([]);
  const [isListening, setIsListening] = useState(false);
  const [fadeIn, setFadeIn] = useState(true);
  const [viewH, setViewH] = useState(window.innerHeight);
  const [selP, setSelP] = useState("man");
  const [selG, setSelG] = useState("daily");
  const [selM, setSelM] = useState("thrill");
  const [isGen, setIsGen] = useState(false);
  // 2sec challenge
  const [choices, setChoices] = useState(null); // {a, b}
  const [challengePhase, setChallengePhase] = useState("idle"); // idle | ready | countdown | listening | done
  const [instantCount, setInstantCount] = useState(0);
  const [totalChoices, setTotalChoices] = useState(0);

  const inputRef = useRef(null);
  const scrollRef = useRef(null);
  const recRef = useRef(null);
  const submittingRef = useRef(false);
  const countdownRef = useRef(null);
  const listenTimerRef = useRef(null);

  const fade = () => { setFadeIn(false); requestAnimationFrame(() => requestAnimationFrame(() => setFadeIn(true))); };

  useEffect(() => {
    const fn = () => setViewH(window.visualViewport ? window.visualViewport.height : window.innerHeight);
    if (window.visualViewport) { window.visualViewport.addEventListener("resize", fn); window.visualViewport.addEventListener("scroll", fn); }
    else window.addEventListener("resize", fn);
    fn();
    return () => {
      if (window.visualViewport) { window.visualViewport.removeEventListener("resize", fn); window.visualViewport.removeEventListener("scroll", fn); }
      else window.removeEventListener("resize", fn);
    };
  }, []);

  useEffect(() => {
    if (!inputRef.current) return;
    const el = inputRef.current;
    const ps = () => { setTimeout(() => window.scrollTo(0, 0), 50); setTimeout(() => window.scrollTo(0, 0), 300); };
    el.addEventListener("focus", ps);
    return () => el.removeEventListener("focus", ps);
  }, [phase]);

  useEffect(() => {
    if (scrollRef.current && scenes.length > 0) {
      const els = scrollRef.current.children;
      if (els.length > 0) els[els.length - 1].scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }, [scenes, isLoading]);

  const saveKey = () => { if (!keyInput.trim()) return; localStorage.setItem("bs2_key", keyInput.trim()); setApiKey(keyInput.trim()); setPhase("title"); };

  const killMic = useCallback(() => {
    if (recRef.current) { try { recRef.current.abort(); } catch(e) {} try { recRef.current.stop(); } catch(e) {} recRef.current.onresult = null; recRef.current.onerror = null; recRef.current.onend = null; recRef.current = null; }
    setIsListening(false);
  }, []);

  const callAPI = async (system, messages) => {
    const res = await fetch("/api/chat", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ apiKey, system, messages }) });
    if (!res.ok) { let m = "HTTP " + res.status; try { m += ": " + (await res.text()).slice(0, 200); } catch(e) {} throw new Error(m); }
    return await res.json();
  };

  const parseJSON = (raw) => {
    try { return JSON.parse(raw.replace(/```json\s*/g, "").replace(/```/g, "").trim()); } catch { return null; }
  };

  // Generate story
  const genStory = async () => {
    setIsGen(true);
    const prompt = STORY_GEN.replace("{protagonist}", PROTAGS.find(p => p.id === selP).label).replace("{genre}", GENRES.find(g => g.id === selG).label).replace("{mood}", MOODS.find(m => m.id === selM).label);
    try {
      const data = await callAPI(prompt, [{ role: "user", content: "„Çπ„Éà„Éº„É™„Éº„Çí‰Ωú„Å£„Å¶„ÄÇ" }]);
      const raw = data.content.map(c => c.type === "text" ? c.text : "").filter(Boolean).join("\n");
      const s = parseJSON(raw);
      if (!s) throw new Error("JSON parse failed");
      const sc = { id: "g" + Date.now(), title: s.title, genre: s.genre, setting: s.setting, firstScene: s.firstScene };
      setScenario(sc);
      setScenes([{ type: "scene", text: sc.firstScene, sceneNumber: 0 }]);
      setHistory([
        { role: "user", content: "Ë®≠ÂÆöÔºö„Äå" + sc.title + "„Äç\n" + sc.setting + "\n\nÊúÄÂàù„ÅÆÂ†¥Èù¢Ôºö\n" + sc.firstScene + "\n\nsceneNumber=1„Åã„Çâ„ÄÇ‰∫ÜËß£„Å®„Å†„ÅëÁ≠î„Åà„Å¶„ÄÇ" },
        { role: "assistant", content: "‰∫ÜËß£" }
      ]);
      setChoices(s.choiceA && s.choiceB ? { a: s.choiceA, b: s.choiceB } : null);
      setChallengePhase("idle");
      setActionLog([]); setEnding(null); setInstantCount(0); setTotalChoices(0); submittingRef.current = false; fade(); setPhase("playing");
    } catch (err) { alert("„Ç®„É©„Éº: " + err.message); }
    setIsGen(false);
  };

  // 2sec challenge flow
  const startChallenge = () => {
    setChallengePhase("countdown");
    // Show choices for 2 sec, then auto-start mic
    countdownRef.current = setTimeout(() => {
      setChallengePhase("listening");
      startChallengeListening();
    }, 2000);
  };

  const startChallengeListening = () => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { setChallengePhase("done"); doSubmitChoice("ÔºàÈü≥Â£∞ÈùûÂØæÂøúÔºâ"); return; }
    try {
      killMic();
      const r = new SR();
      r.lang = "ja-JP"; r.interimResults = false; r.continuous = false;
      recRef.current = r;
      const startTime = Date.now();
      r.onresult = (e) => {
        const t = e.results[0][0].transcript;
        const elapsed = (Date.now() - startTime) / 1000;
        killMic();
        clearTimeout(listenTimerRef.current);
        setTotalChoices(c => c + 1);
        if (elapsed <= 2) setInstantCount(c => c + 1);
        setChallengePhase("done");
        doSubmitChoice(t);
      };
      r.onerror = (e) => {
        killMic();
        clearTimeout(listenTimerRef.current);
        if (e.error !== "aborted") {
          setChallengePhase("done");
          setTotalChoices(c => c + 1);
          doSubmitChoice("ÔºàËø∑„Å£„ÅüÔºâ");
        }
      };
      r.onend = () => setIsListening(false);
      r.start(); setIsListening(true);
      // 2sec listening limit
      listenTimerRef.current = setTimeout(() => {
        killMic();
        setChallengePhase("done");
        setTotalChoices(c => c + 1);
        doSubmitChoice("ÔºàËø∑„Å£„ÅüÔºâ");
      }, 2500);
    } catch (err) { setChallengePhase("done"); doSubmitChoice("Ôºà„Ç®„É©„ÉºÔºâ"); }
  };

  const doSubmitChoice = async (text) => {
    if (submittingRef.current) return;
    submittingRef.current = true;
    setUserInput("");
    setScenes(p => [...p, { type: "action", text }]);
    setActionLog(p => [...p, text]);
    setIsLoading(true);
    setChoices(null);

    const nh = [...history, { role: "user", content: text }];
    const th = nh.length <= 14 ? nh : [...nh.slice(0, 2), ...nh.slice(-12)];

    try {
      const data = await callAPI(SYS, th);
      const raw = data.content.map(c => c.type === "text" ? c.text : "").filter(Boolean).join("\n");
      const p = parseJSON(raw) || { narrative: raw || "...", situation: "", sceneNumber: scenes.filter(s => s.type === "scene").length + 1, isEnding: false, choiceA: "", choiceB: "" };
      setScenes(prev => [...prev, { type: "scene", text: p.narrative, sceneNumber: p.sceneNumber, situation: p.situation }]);
      setHistory([...nh, { role: "assistant", content: JSON.stringify(p) }]);
      if (p.isEnding) {
        setEnding({ title: p.endingTitle || "ÁµêÊú´", summary: p.endingSummary || "" });
        setChoices(null);
      } else {
        setChoices(p.choiceA && p.choiceB ? { a: p.choiceA, b: p.choiceB } : null);
        setChallengePhase("idle");
      }
    } catch (err) {
      setScenes(prev => [...prev, { type: "scene", text: "Ôºà„Ç®„É©„Éº: " + err.message + "Ôºâ", sceneNumber: -1 }]);
    }
    setIsLoading(false);
    submittingRef.current = false;
  };

  // Manual text/voice submit (fallback)
  const startListening = () => {
    if (isLoading || submittingRef.current) return;
    killMic();
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return;
    try {
      const r = new SR(); r.lang = "ja-JP"; r.interimResults = true; r.continuous = false; recRef.current = r;
      r.onresult = (e) => { const t = Array.from(e.results).map(x => x[0].transcript).join(""); setUserInput(t); if (e.results[e.results.length-1].isFinal) { killMic(); if (!submittingRef.current) { submittingRef.current = true; doSubmitChoice(t); } } };
      r.onerror = (e) => { killMic(); };
      r.onend = () => setIsListening(false);
      r.start(); setIsListening(true);
    } catch(e) {}
  };

  const submitAction = () => { if (!userInput.trim() || isLoading || submittingRef.current) return; submittingRef.current = true; killMic(); doSubmitChoice(userInput.trim()); };
  const onKey = (e) => { if (e.key === "Enter" && !e.shiftKey && !e.nativeEvent.isComposing) { e.preventDefault(); submitAction(); } };

  const ctr = { height: viewH, background: "linear-gradient(180deg,#0d0d1a 0%,#141428 50%,#0d0d1a 100%)", display: "flex", justifyContent: "center", alignItems: "flex-start", padding: "8px 8px 0", overflow: "hidden" };
  const card = { width: "100%", maxWidth: 500, height: "100%", background: "linear-gradient(165deg,#181830 0%,#12122a 100%)", borderRadius: "20px 20px 0 0", border: "1px solid #2a2a44", borderBottom: "none", padding: "16px 16px 0", opacity: fadeIn ? 1 : 0, transform: fadeIn ? "translateY(0)" : "translateY(12px)", transition: "opacity 0.4s,transform 0.4s", display: "flex", flexDirection: "column", overflow: "hidden" };
  const chip = (sel) => ({ padding: "10px 16px", border: "none", borderRadius: 10, background: sel ? "#64dfdf22" : "transparent", outline: sel ? "1.5px solid #64dfdf66" : "1.5px solid #2a2a42", color: sel ? "#64dfdf" : "#7a7a8a", fontSize: 15, fontWeight: sel ? 600 : 400, cursor: "pointer" });

  return (
    <div style={ctr}>
      <div style={card}>

        {/* SETUP */}
        {phase === "setup" && (
          <div style={{ textAlign: "center", animation: "slideUp 0.6s ease", overflowY: "auto", flex: 1, paddingBottom: 20 }}>
            <div style={{ ...mf, fontSize: 12, color: "#64dfdf", letterSpacing: 4, marginBottom: 16 }}>STILLNOVA STUDIO</div>
            <h1 style={{ fontSize: 28, color: "#e8e8f0", fontWeight: 700, marginBottom: 24 }}>Brain Story 2sec</h1>
            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: 20, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 12, color: "#64dfdf", marginBottom: 10 }}>API KEY</div>
              <p style={{ fontSize: 14, color: "#7a7a8a", lineHeight: 1.7, marginBottom: 12 }}>Claude API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
              <input type="password" value={keyInput} onChange={e => setKeyInput(e.target.value)} placeholder="sk-ant-..."
                style={{ width: "100%", padding: "14px 16px", background: "#12122a", border: "1.5px solid #2a2a42", borderRadius: 12, color: "#d4d4e0", fontSize: 16, marginBottom: 12 }} />
              <button onClick={saveKey} style={{ width: "100%", padding: 16, border: "none", borderRadius: 14, background: keyInput.trim() ? "linear-gradient(135deg,#64dfdf,#4ab8b8)" : "#2a2a42", color: keyInput.trim() ? "#0d0d1a" : "#5a5a6a", fontSize: 16, fontWeight: 700, cursor: keyInput.trim() ? "pointer" : "default" }}>„ÅØ„Åò„ÇÅ„Çã</button>
            </div>
          </div>
        )}

        {/* TITLE */}
        {phase === "title" && (
          <div style={{ textAlign: "center", animation: "slideUp 0.6s ease", overflowY: "auto", flex: 1, paddingBottom: 20 }}>
            <div style={{ ...mf, fontSize: 12, color: "#64dfdf", letterSpacing: 4, marginBottom: 10 }}>STILLNOVA STUDIO</div>
            <h1 style={{ fontSize: 28, color: "#e8e8f0", fontWeight: 700, marginBottom: 2 }}>Brain Story</h1>
            <div style={{ ...mf, fontSize: 22, color: "#64dfdf", marginBottom: 14, letterSpacing: 2 }}>2<span style={{ fontSize: 14, verticalAlign: "super" }}>sec</span></div>

            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: "14px 14px", marginBottom: 8, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 12, color: "#64dfdf", marginBottom: 8 }}>‰∏ª‰∫∫ÂÖ¨</div>
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                {PROTAGS.map(p => <button key={p.id} onClick={() => setSelP(p.id)} style={chip(selP === p.id)}>{p.label}</button>)}
              </div>
            </div>

            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: "14px 14px", marginBottom: 8, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 12, color: "#64dfdf", marginBottom: 8 }}>„Ç∏„É£„É≥„É´</div>
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                {GENRES.map(g => <button key={g.id} onClick={() => setSelG(g.id)} style={chip(selG === g.id)}>{g.label}</button>)}
              </div>
            </div>

            <div style={{ background: "#1a1a2e", borderRadius: 16, padding: "14px 14px", marginBottom: 14, border: "1px solid #2a2a42", textAlign: "left" }}>
              <div style={{ ...mf, fontSize: 12, color: "#64dfdf", marginBottom: 8 }}>Ê∞óÂàÜ</div>
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                {MOODS.map(m => <button key={m.id} onClick={() => setSelM(m.id)} style={chip(selM === m.id)}>{m.label}</button>)}
              </div>
            </div>

            <button onClick={genStory} disabled={isGen}
              style={{ width: "100%", padding: 16, border: "none", borderRadius: 14, background: isGen ? "#2a2a42" : "linear-gradient(135deg,#64dfdf,#4ab8b8)", color: isGen ? "#5a5a6a" : "#0d0d1a", fontSize: 17, fontWeight: 700, cursor: isGen ? "default" : "pointer", marginBottom: 8 }}>
              {isGen ? "ÁîüÊàê‰∏≠..." : "Áâ©Ë™û„Çí„ÅØ„Åò„ÇÅ„Çã"}
            </button>
            <p style={{ fontSize: 13, color: "#5a5a6a", marginBottom: 4 }}>ÊØéÂõûAI„ÅåÈÅï„ÅÜÁâ©Ë™û„Çí‰Ωú„Çä„Åæ„Åô</p>
            <button onClick={() => { localStorage.removeItem("bs2_key"); setApiKey(""); setPhase("setup"); }} style={{ background: "none", border: "none", color: "#3a3a52", fontSize: 12, cursor: "pointer" }}>API„Ç≠„Éº„ÇíÂ§âÊõ¥</button>
          </div>
        )}

        {/* PLAYING */}
        {phase === "playing" && scenario && (
          <>
            <div style={{ marginBottom: 8, flexShrink: 0, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ ...mf, fontSize: 12, color: "#64dfdf", letterSpacing: 2 }}>{scenario.genre} ‚Äî {scenario.title}</span>
              <span style={{ ...mf, fontSize: 12, color: "#5a5a6a" }}>SCENE {scenes.filter(s => s.type === "scene").length}</span>
            </div>

            <div ref={scrollRef} style={{ flex: 1, overflowY: "auto", marginBottom: 8, paddingRight: 4, minHeight: 0 }}>
              {scenes.map((s, i) => (
                <div key={i} style={{ marginBottom: 14, animation: i === scenes.length - 1 ? "slideUp 0.4s ease" : "none" }}>
                  {s.type === "scene" ? (
                    <div>
                      {s.situation && <div style={{ fontSize: 13, color: "#64dfdf88", marginBottom: 4, ...mf }}>{s.situation}</div>}
                      <p style={{ fontSize: 17, color: "#e0e0ec", lineHeight: 1.9, whiteSpace: "pre-wrap" }}>{s.text}</p>
                    </div>
                  ) : (
                    <div style={{ padding: "10px 14px", marginLeft: 16, background: "#64dfdf10", border: "1px solid #64dfdf33", borderRadius: 12 }}>
                      <p style={{ fontSize: 16, color: "#e8e8f0", lineHeight: 1.6 }}>{s.text}</p>
                    </div>
                  )}
                </div>
              ))}
              {isLoading && (
                <div style={{ padding: "12px 0", display: "flex", alignItems: "center", gap: 8 }}>
                  <div style={{ display: "flex", gap: 4 }}>
                    {[0,1,2].map(i => <div key={i} style={{ width: 7, height: 7, borderRadius: "50%", background: "#64dfdf", animation: `breathe 1.2s ${i*0.3}s infinite` }} />)}
                  </div>
                  <span style={{ fontSize: 14, color: "#5a5a6a" }}>Â±ïÈñã‰∏≠...</span>
                </div>
              )}
            </div>

            {/* Bottom area */}
            {!ending ? (
              <div style={{ flexShrink: 0, paddingBottom: 8 }}>
                {/* 2sec Challenge UI */}
                {choices && !isLoading && challengePhase === "idle" && (
                  <button onClick={startChallenge}
                    style={{ width: "100%", padding: 14, border: "none", borderRadius: 14, background: "linear-gradient(135deg,#ffd166,#ffb347)", color: "#0d0d1a", fontSize: 17, fontWeight: 700, cursor: "pointer", marginBottom: 8, letterSpacing: 1 }}>
                    2Áßí„ÉÅ„É£„É¨„É≥„Ç∏ üé§
                  </button>
                )}

                {/* Countdown: show choices */}
                {challengePhase === "countdown" && choices && (
                  <div style={{ animation: "slideUp 0.3s ease", marginBottom: 8 }}>
                    <div style={{ display: "flex", gap: 8, marginBottom: 6 }}>
                      <div style={{ flex: 1, padding: 14, background: "#1a1a2e", border: "1.5px solid #64dfdf44", borderRadius: 12, textAlign: "center" }}>
                        <span style={{ fontSize: 12, color: "#64dfdf88", ...mf }}>A</span>
                        <p style={{ fontSize: 17, color: "#e8e8f0", fontWeight: 600, marginTop: 4 }}>{choices.a}</p>
                      </div>
                      <div style={{ flex: 1, padding: 14, background: "#1a1a2e", border: "1.5px solid #ffd16644", borderRadius: 12, textAlign: "center" }}>
                        <span style={{ fontSize: 12, color: "#ffd16688", ...mf }}>B</span>
                        <p style={{ fontSize: 17, color: "#e8e8f0", fontWeight: 600, marginTop: 4 }}>{choices.b}</p>
                      </div>
                    </div>
                    <div style={{ height: 4, background: "#2a2a42", borderRadius: 2, overflow: "hidden" }}>
                      <div style={{ height: "100%", background: "linear-gradient(90deg,#64dfdf,#ffd166)", animation: "countdown 2s linear forwards", borderRadius: 2 }} />
                    </div>
                    <p style={{ fontSize: 14, color: "#ffd166", textAlign: "center", marginTop: 6, ...mf }}>Ë¶ö„Åà„Å¶...„Åæ„ÇÇ„Å™„ÅèÈü≥Â£∞ÂÖ•Âäõ„Çπ„Çø„Éº„Éà</p>
                  </div>
                )}

                {/* Listening */}
                {challengePhase === "listening" && (
                  <div style={{ textAlign: "center", padding: "14px 0", animation: "slideUp 0.2s ease", marginBottom: 8 }}>
                    <div style={{ fontSize: 28, animation: "pulse 0.6s infinite", marginBottom: 4 }}>üé§</div>
                    <p style={{ fontSize: 17, color: "#ff4757", fontWeight: 700, ...mf }}>‰ªä„Åô„ÅêÁ≠î„Åà„Å¶ÔºÅ</p>
                    <div style={{ height: 4, background: "#2a2a42", borderRadius: 2, overflow: "hidden", marginTop: 8 }}>
                      <div style={{ height: "100%", background: "#ff4757", animation: "countdown 2.5s linear forwards", borderRadius: 2 }} />
                    </div>
                  </div>
                )}

                {/* Manual input (always available) */}
                {challengePhase !== "countdown" && challengePhase !== "listening" && (
                  <div style={{ display: "flex", gap: 6, alignItems: "center" }}>
                    <button onClick={isListening ? killMic : startListening} disabled={isLoading}
                      style={{ width: 44, height: 44, border: "none", borderRadius: 12, background: isListening ? "linear-gradient(135deg,#ff4757,#ff6b6b)" : "#1e1e32", color: isListening ? "#fff" : "#6a6a7a", fontSize: 18, cursor: "pointer", flexShrink: 0, display: "flex", alignItems: "center", justifyContent: "center", opacity: isLoading ? 0.4 : 1, animation: isListening ? "pulse 1s infinite" : "none" }}>üé§</button>
                    <input ref={inputRef} type="text" value={userInput} onChange={e => setUserInput(e.target.value)} onKeyDown={onKey}
                      placeholder="Ëá™Áî±„Å´ÂÖ•Âäõ„ÇÇOK" disabled={isLoading}
                      style={{ flex: 1, padding: "10px 14px", background: "#1a1a2e", border: "1.5px solid #2a2a42", borderRadius: 12, color: "#d4d4e0", fontSize: 16, lineHeight: 1.4, opacity: isLoading ? 0.4 : 1 }} />
                    <button onClick={submitAction} disabled={!userInput.trim() || isLoading}
                      style={{ padding: "10px 14px", border: "none", borderRadius: 12, background: userInput.trim() && !isLoading ? "linear-gradient(135deg,#64dfdf,#4ab8b8)" : "#2a2a42", color: userInput.trim() ? "#0d0d1a" : "#5a5a6a", fontSize: 15, fontWeight: 700, cursor: userInput.trim() ? "pointer" : "default", flexShrink: 0, height: 44 }}>‚Üí</button>
                  </div>
                )}
              </div>
            ) : (
              <div style={{ flexShrink: 0, animation: "slideUp 0.5s ease", paddingBottom: 8 }}>
                <div style={{ background: "#1a1a2e", borderRadius: 14, padding: 14, border: "1px solid #64dfdf33", marginBottom: 10 }}>
                  <div style={{ ...mf, fontSize: 11, color: "#64dfdf", letterSpacing: 3, marginBottom: 6 }}>ENDING</div>
                  <div style={{ fontSize: 20, color: "#e8e8f0", fontWeight: 700, marginBottom: 8, lineHeight: 1.4 }}>{ending.title}</div>
                  <p style={{ fontSize: 15, color: "#a0a0b0", lineHeight: 1.8 }}>{ending.summary}</p>
                  {totalChoices > 0 && (
                    <div style={{ marginTop: 10, padding: "8px 12px", background: "#12122a", borderRadius: 10, display: "flex", gap: 12, justifyContent: "center" }}>
                      <span style={{ ...mf, fontSize: 14, color: "#ffd166" }}>Âç≥Êñ≠ {instantCount}/{totalChoices}</span>
                    </div>
                  )}
                </div>
                <div style={{ display: "flex", gap: 8 }}>
                  <button onClick={() => { killMic(); fade(); setPhase("ending"); }} style={{ flex: 1, padding: 14, border: "none", borderRadius: 14, background: "linear-gradient(135deg,#64dfdf,#4ab8b8)", color: "#0d0d1a", fontSize: 15, fontWeight: 700, cursor: "pointer" }}>ÊåØ„ÇäËøî„Çä</button>
                  <button onClick={() => { killMic(); fade(); setPhase("title"); }} style={{ flex: 1, padding: 14, border: "1.5px solid #3a3a52", borderRadius: 14, background: "transparent", color: "#8a8a9a", fontSize: 15, cursor: "pointer" }}>Ê¨°„ÅÆÁâ©Ë™û</button>
                </div>
              </div>
            )}
          </>
        )}

        {/* ENDING */}
        {phase === "ending" && ending && scenario && (
          <div style={{ animation: "slideUp 0.6s ease", overflowY: "auto", flex: 1, paddingBottom: 20 }}>
            <div style={{ ...mf, fontSize: 12, color: "#64dfdf", letterSpacing: 3, marginBottom: 20, textAlign: "center" }}>ENDING</div>
            <div style={{ fontSize: 24, color: "#e8e8f0", fontWeight: 700, marginBottom: 16, lineHeight: 1.4, textAlign: "center" }}>{ending.title}</div>
            <p style={{ fontSize: 16, color: "#a0a0b0", lineHeight: 2, marginBottom: 16 }}>{ending.summary}</p>

            {totalChoices > 0 && (
              <div style={{ background: "#1a1a2e", borderRadius: 14, padding: 16, marginBottom: 16, border: "1px solid #ffd16633", textAlign: "center" }}>
                <div style={{ ...mf, fontSize: 12, color: "#ffd166", marginBottom: 8 }}>2SEC CHALLENGE</div>
                <div style={{ fontSize: 32, color: "#ffd166", fontWeight: 700, ...mf }}>{instantCount}/{totalChoices}</div>
                <p style={{ fontSize: 14, color: "#7a7a8a", marginTop: 4 }}>Âõû„ÅÆÂç≥Êñ≠„Å´ÊàêÂäü</p>
              </div>
            )}

            <div style={{ background: "#1a1a2e", borderRadius: 14, padding: 16, marginBottom: 14, border: "1px solid #2a2a42", maxHeight: 350, overflowY: "auto" }}>
              <div style={{ ...mf, fontSize: 12, color: "#64dfdf", letterSpacing: 2, marginBottom: 12 }}>FULL STORY</div>
              <p style={{ fontSize: 15, color: "#8a8a9a", lineHeight: 1.8, marginBottom: 10, whiteSpace: "pre-wrap" }}>{scenario.firstScene}</p>
              {scenes.slice(1).map((s, i) => (
                <div key={i} style={{ marginBottom: 10 }}>
                  {s.type === "action" ? (
                    <div style={{ padding: "6px 10px", marginLeft: 12, background: "#64dfdf08", border: "1px solid #64dfdf22", borderRadius: 8 }}>
                      <span style={{ fontSize: 14, color: "#c4c4d0" }}>{s.text}</span>
                    </div>
                  ) : (
                    <p style={{ fontSize: 14, color: "#8a8a9a", lineHeight: 1.8, whiteSpace: "pre-wrap" }}>{s.text}</p>
                  )}
                </div>
              ))}
            </div>

            <button onClick={() => { fade(); setPhase("title"); }} style={{ width: "100%", padding: 16, border: "none", borderRadius: 14, background: "linear-gradient(135deg,#64dfdf,#4ab8b8)", color: "#0d0d1a", fontSize: 17, fontWeight: 700, cursor: "pointer", marginBottom: 8 }}>Êñ∞„Åó„ÅÑÁâ©Ë™û„Çí„ÅØ„Åò„ÇÅ„Çã</button>
          </div>
        )}

      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
