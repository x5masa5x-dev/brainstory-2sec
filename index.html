<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brain Story 5sec</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html{height:100%;overflow:hidden}
  body{background:#0d0d1a;font-family:'Noto Sans JP',sans-serif;height:100%;overflow:hidden}
  button,input{font-family:inherit;-webkit-appearance:none}
  button:focus,input:focus{outline:none}
  input[type="text"]{font-size:16px!important}
  @keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
  @keyframes breathe{0%,100%{opacity:.4}50%{opacity:.8}}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}
  @keyframes countdown5{from{width:100%}to{width:0%}}
  ::-webkit-scrollbar{width:4px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:#2a2a44;border-radius:2px}
  #root{height:100%}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const {useState,useRef,useEffect,useCallback}=React;

const SYS=`ã‚ãªãŸã¯ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚

å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§è¿”ç­”ã€‚JSONä»¥å¤–ã¯å‡ºåŠ›ç¦æ­¢ã€‚çµµæ–‡å­—ãƒ»ç‰¹æ®Šè¨˜å·ã¯ç¦æ­¢ã€‚
{"narrative":"å ´é¢ã®æå†™","situation":"çŠ¶æ³1æ–‡","sceneNumber":1,"isEnding":false,"endingTitle":"","endingSummary":""}

# æ–‡ä½“ï¼ˆæœ€é‡è¦ï¼‰
- å°å­¦æ ¡é«˜å­¦å¹´ãŒèª­ã‚ã‚‹ã‚„ã•ã—ã„æ—¥æœ¬èª
- 1æ–‡ã¯çŸ­ãã€‚40æ–‡å­—ä»¥å†…
- é›£ã—ã„è¨€è‘‰ã€æ¯”å–©ã¯ç¦æ­¢
- narrativeã¯3ã€œ4æ–‡
- narrativeã®æœ€å¾Œã¯å¿…ãšã€Œã‚ãªãŸãªã‚‰ã©ã†ã™ã‚‹ï¼Ÿã€ã§çµ‚ãˆã‚‹
- isEnding=trueã®å ´åˆã®ã¿ã€Œã‚ãªãŸãªã‚‰ã©ã†ã™ã‚‹ï¼Ÿã€ã¯ä¸è¦

# å…¥åŠ›ã®è§£é‡ˆ
- ã©ã‚“ãªå›ç­”ã‚‚ã§ãã‚‹ã ã‘ç‰©èªã«åæ˜ ã™ã‚‹
- ãµã–ã‘ãŸå›ç­”â†’ãƒ¦ãƒ¼ãƒ¢ã‚¢ã§å‡¦ç†ã—ã¦é€²ã‚ã‚‹
- æ›–æ˜§ãªå›ç­”â†’ä¸»äººå…¬ãŒå°‘ã—è¿·ã„ã¤ã¤è¡Œå‹•ã™ã‚‹æå†™ã«ã™ã‚‹
- å±é™ºãƒ»æš´åŠ›â†’æˆåŠŸã•ã›ãªã„
- ã€Œæ™‚é–“åˆ‡ã‚Œã€ã€Œè¿·ã£ãŸã€ã€Œèãå–ã‚Œãªã‹ã£ãŸã€â†’ä¸»äººå…¬ãŒè¿·ã£ã¦ã„ã‚‹é–“ã«çŠ¶æ³ãŒå¤‰ã‚ã‚‹æå†™ã«ã—ã¦ç‰©èªã‚’å‰ã«é€²ã‚ã‚‹ã€‚åŒã˜å ´é¢ã‚’ç¹°ã‚Šè¿”ã—ã¦ã¯ã„ã‘ãªã„

# çµ¶å¯¾ç¦æ­¢
- å‰ã®å ´é¢ã¨åŒã˜å†…å®¹ãƒ»åŒã˜æå†™ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨
- ç‰©èªãŒæ­¢ã¾ã‚‹ã“ã¨ã€‚ã©ã‚“ãªå…¥åŠ›ã§ã‚‚å¿…ãšæ–°ã—ã„å±•é–‹ã«ã™ã‚‹ã“ã¨

# ç‰©èª
- scene 1ã®ç‰©ã‚„äººãŒå¾Œã§é‡è¦ã«ãªã‚‹ã‚ˆã†ã«ä»•è¾¼ã‚€
- scene 2ã€œ3ã§æ„å¤–ãªå±•é–‹ã‚’å…¥ã‚Œã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ¤æ–­ãŒå¾Œã®å ´é¢ã«å½±éŸ¿ã™ã‚‹
- è‰¯ã„ã“ã¨ã‚‚æ‚ªã„ã“ã¨ã‚‚èµ·ãã‚‹ã€‚æ‚ªã„ã“ã¨ã°ã‹ã‚Šç¶šã‘ãªã„

# çµæœ«ï¼ˆ5ã€œ6å ´é¢ï¼‰
- sceneNumberã¯1ã‹ã‚‰+1ã€‚scene 4ã‹ã‚‰åæŸã€‚scene 5ã€œ6ã§isEnding=trueã€‚6è¶…ãˆç¦æ­¢
- ã€Œã‚ã®è¡Œå‹•ãŒã“ã“ã«ç¹‹ãŒã£ãŸã€ã¨æ€ãˆã‚‹æ§‹æˆã«ã™ã‚‹
- endingSummaryã¯3æ–‡ï¼šæŒ¯ã‚Šè¿”ã‚Šã€åˆ¤æ–­ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æã€ã²ã¨ã“ã¨`;

const SGEN=`æ¡ä»¶ï¼šä¸»äººå…¬={p}ã€ã‚¸ãƒ£ãƒ³ãƒ«={g}ã€æ°—åˆ†={m}

JSONå½¢å¼ã®ã¿ã€‚çµµæ–‡å­—ç¦æ­¢ã€‚ã‚„ã•ã—ã„æ—¥æœ¬èªã€‚1æ–‡40æ–‡å­—ä»¥å†…ã€‚
{"title":"ã‚¿ã‚¤ãƒˆãƒ«","genre":"ã‚¸ãƒ£ãƒ³ãƒ«çŸ­ç¸®","setting":"2æ–‡ã®è¨­å®šã€‚ç§˜å¯†ã‹ã‚¿ã‚¤ãƒ ãƒªãƒŸãƒƒãƒˆã‚’å«ã‚€","firstScene":"æœ€åˆã®å ´é¢3ã€œ4æ–‡ã€‚æœ€å¾Œã¯ã€Œã‚ãªãŸãªã‚‰ã©ã†ã™ã‚‹ï¼Ÿã€ã§çµ‚ãˆã‚‹"}`;

const PS=[{id:"man",l:"ç”·æ€§"},{id:"woman",l:"å¥³æ€§"},{id:"child",l:"å­ä¾›"},{id:"other",l:"äººé–“ä»¥å¤–"}];
const GS=[{id:"work",l:"ä»•äº‹"},{id:"daily",l:"æ—¥å¸¸"},{id:"mystery",l:"ãƒŸã‚¹ãƒ†ãƒªãƒ¼"},{id:"scifi",l:"SF"},{id:"fantasy",l:"ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼"},{id:"survival",l:"ã‚µãƒã‚¤ãƒãƒ«"}];
const MS=[{id:"thrill",l:"ãƒãƒ©ãƒãƒ©"},{id:"warm",l:"ã»ã£ã“ã‚Š"},{id:"think",l:"è€ƒãˆã•ã›ã‚‰ã‚Œã‚‹"},{id:"funny",l:"ç¬‘ãˆã‚‹"}];
const mf={fontFamily:"'DM Mono',monospace"};

function App(){
  const [apiKey,setApiKey]=useState(localStorage.getItem("bs5_key")||"");
  const [keyIn,setKeyIn]=useState("");
  const [phase,setPhase]=useState(apiKey?"title":"setup");
  const [sc,setSc]=useState(null);
  const [scenes,setScenes]=useState([]);
  const [uIn,setUIn]=useState("");
  const [loading,setLoading]=useState(false);
  const [hist,setHist]=useState([]);
  const [ending,setEnding]=useState(null);
  const [aLog,setALog]=useState([]);
  const [listening,setListening]=useState(false);
  const [fi,setFi]=useState(true);
  const [vh,setVh]=useState(window.innerHeight);
  const [sp,setSp]=useState("man");
  const [sg,setSg]=useState("daily");
  const [sm,setSm]=useState("thrill");
  const [gen,setGen]=useState(false);
  // 5sec challenge state
  const [challenging,setChallenging]=useState(false);
  const [fast,setFast]=useState(0);
  const [total,setTotal]=useState(0);

  const iRef=useRef(null);
  const sRef=useRef(null);
  const rRef=useRef(null);
  const subRef=useRef(false);
  const ltRef=useRef(null);
  const t0Ref=useRef(0);

  const fade=()=>{setFi(false);requestAnimationFrame(()=>requestAnimationFrame(()=>setFi(true)))};

  useEffect(()=>{
    const fn=()=>setVh(window.visualViewport?window.visualViewport.height:window.innerHeight);
    const vv=window.visualViewport;
    if(vv){vv.addEventListener("resize",fn);vv.addEventListener("scroll",fn)}
    else window.addEventListener("resize",fn);
    fn();
    return()=>{if(vv){vv.removeEventListener("resize",fn);vv.removeEventListener("scroll",fn)}else window.removeEventListener("resize",fn)};
  },[]);

  useEffect(()=>{
    if(!iRef.current)return;const el=iRef.current;
    const ps=()=>{setTimeout(()=>window.scrollTo(0,0),50);setTimeout(()=>window.scrollTo(0,0),300)};
    el.addEventListener("focus",ps);return()=>el.removeEventListener("focus",ps);
  },[phase]);

  useEffect(()=>{
    if(sRef.current&&scenes.length>0){
      const els=sRef.current.children;
      if(els.length>0)els[els.length-1].scrollIntoView({behavior:"smooth",block:"start"});
    }
  },[scenes,loading]);

  const saveKey=()=>{if(!keyIn.trim())return;localStorage.setItem("bs5_key",keyIn.trim());setApiKey(keyIn.trim());setPhase("title")};

  const stopRec=()=>{
    if(rRef.current){try{rRef.current.abort()}catch(e){}try{rRef.current.stop()}catch(e){}rRef.current.onresult=null;rRef.current.onerror=null;rRef.current.onend=null;rRef.current=null}
    setListening(false);clearTimeout(ltRef.current);
  };

  const callAPI=async(system,messages)=>{
    const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey,system,messages})});
    if(!res.ok){let m="HTTP "+res.status;try{m+=": "+(await res.text()).slice(0,200)}catch(e){}throw new Error(m)}
    return await res.json();
  };
  const pJ=(raw)=>{try{return JSON.parse(raw.replace(/```json\s*/g,"").replace(/```/g,"").trim())}catch{return null}};

  // === STORY GENERATION ===
  const genStory=async()=>{
    setGen(true);
    const pr=SGEN.replace("{p}",PS.find(p=>p.id===sp).l).replace("{g}",GS.find(g=>g.id===sg).l).replace("{m}",MS.find(m=>m.id===sm).l);
    try{
      const data=await callAPI(pr,[{role:"user",content:"ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ä½œã£ã¦ã€‚"}]);
      const raw=data.content.map(c=>c.type==="text"?c.text:"").filter(Boolean).join("\n");
      const s=pJ(raw);
      if(!s)throw new Error("ç”Ÿæˆå¤±æ•—ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„");
      const scenario={id:"g"+Date.now(),title:s.title,genre:s.genre,setting:s.setting,firstScene:s.firstScene};
      setSc(scenario);
      setScenes([{type:"scene",text:scenario.firstScene,sceneNumber:0}]);
      setHist([{role:"user",content:"è¨­å®šï¼šã€Œ"+scenario.title+"ã€\n"+scenario.setting+"\n\næœ€åˆã®å ´é¢ï¼š\n"+scenario.firstScene+"\n\nsceneNumber=1ã‹ã‚‰ã€‚äº†è§£ã¨ã ã‘ç­”ãˆã¦ã€‚"},{role:"assistant",content:"äº†è§£"}]);
      setALog([]);setEnding(null);setFast(0);setTotal(0);subRef.current=false;setChallenging(false);fade();setPhase("playing");
      // Warm up SpeechRecognition (Safari needs first-run init)
      try{
        const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
        if(SR){const w=new SR();w.lang="ja-JP";w.onend=()=>{};w.onerror=()=>{};w.start();setTimeout(()=>{try{w.abort()}catch(e){}},200)}
      }catch(e){}
    }catch(err){alert("ã‚¨ãƒ©ãƒ¼: "+err.message)}
    setGen(false);
  };

  // === SUBMIT (shared by all input methods) ===
  const doSubmit=async(text,wasChallengeSuccess)=>{
    if(subRef.current)return;subRef.current=true;
    stopRec();setChallenging(false);setUIn("");
    if(wasChallengeSuccess!==undefined){
      setTotal(t=>t+1);
      if(wasChallengeSuccess)setFast(f=>f+1);
    }
    setScenes(p=>[...p,{type:"action",text}]);
    setALog(p=>[...p,text]);
    setLoading(true);

    const nh=[...hist,{role:"user",content:text}];
    const th=nh.length<=14?nh:[...nh.slice(0,2),...nh.slice(-12)];
    try{
      const data=await callAPI(SYS,th);
      const raw=data.content.map(c=>c.type==="text"?c.text:"").filter(Boolean).join("\n");
      const p=pJ(raw)||{narrative:raw||"...",situation:"",sceneNumber:scenes.filter(s=>s.type==="scene").length+1,isEnding:false};
      setScenes(prev=>[...prev,{type:"scene",text:p.narrative,sceneNumber:p.sceneNumber,situation:p.situation}]);
      setHist([...nh,{role:"assistant",content:JSON.stringify(p)}]);
      if(p.isEnding)setEnding({title:p.endingTitle||"çµæœ«",summary:p.endingSummary||""});
    }catch(err){setScenes(prev=>[...prev,{type:"scene",text:"ï¼ˆã‚¨ãƒ©ãƒ¼: "+err.message+"ï¼‰",sceneNumber:-1}])}
    setLoading(false);subRef.current=false;
  };

  // === 5SEC CHALLENGE ===
  // Uses the EXACT same SpeechRecognition code as the working ğŸ¤ button
  const startChallenge=()=>{
    if(loading||subRef.current)return;
    stopRec();
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){doSubmit("ï¼ˆéŸ³å£°éå¯¾å¿œï¼‰",false);return}
    const r=new SR();
    r.lang="ja-JP";r.interimResults=true;r.continuous=false;
    rRef.current=r;
    t0Ref.current=Date.now();
    let submitted=false;

    r.onresult=(e)=>{
      const t=Array.from(e.results).map(x=>x[0].transcript).join("");
      setUIn(t);
      if(e.results[e.results.length-1].isFinal&&!submitted){
        submitted=true;
        const sec=(Date.now()-t0Ref.current)/1000;
        clearTimeout(ltRef.current);
        stopRec();
        doSubmit(t,sec<=5);
      }
    };
    r.onerror=(e)=>{
      if(submitted)return;submitted=true;
      clearTimeout(ltRef.current);stopRec();
      if(e.error!=="aborted")doSubmit("ï¼ˆèãå–ã‚Œãªã‹ã£ãŸï¼‰",false);
    };
    r.onend=()=>{
      setListening(false);
      if(!submitted){submitted=true;clearTimeout(ltRef.current);
        if(uIn&&uIn.trim()){doSubmit(uIn.trim(),((Date.now()-t0Ref.current)/1000)<=5)}
      }
    };

    r.start();
    setListening(true);
    setChallenging(true);

    ltRef.current=setTimeout(()=>{
      if(submitted)return;submitted=true;
      stopRec();doSubmit("ï¼ˆæ™‚é–“åˆ‡ã‚Œï¼‰",false);
    },6000);
  };

  // === MANUAL MIC (same code that already works) ===
  const manualMic=()=>{
    if(loading||subRef.current)return;
    stopRec();
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR)return;
    const r=new SR();r.lang="ja-JP";r.interimResults=true;r.continuous=false;
    rRef.current=r;
    r.onresult=(e)=>{
      const t=Array.from(e.results).map(x=>x[0].transcript).join("");
      setUIn(t);
      if(e.results[e.results.length-1].isFinal){stopRec();if(!subRef.current)doSubmit(t)}
    };
    r.onerror=()=>stopRec();
    r.onend=()=>setListening(false);
    r.start();setListening(true);
  };

  const manualSubmit=()=>{if(!uIn.trim()||loading||subRef.current)return;stopRec();doSubmit(uIn.trim())};
  const onKey=(e)=>{if(e.key==="Enter"&&!e.shiftKey&&!e.nativeEvent.isComposing){e.preventDefault();manualSubmit()}};

  // === STYLES ===
  const ctr={height:vh,background:"linear-gradient(180deg,#0d0d1a,#141428,#0d0d1a)",display:"flex",justifyContent:"center",alignItems:"flex-start",padding:"8px 8px 0",overflow:"hidden"};
  const card={width:"100%",maxWidth:500,height:"100%",background:"linear-gradient(165deg,#181830,#12122a)",borderRadius:"20px 20px 0 0",border:"1px solid #2a2a44",borderBottom:"none",padding:"16px 16px 0",opacity:fi?1:0,transform:fi?"translateY(0)":"translateY(12px)",transition:"opacity .4s,transform .4s",display:"flex",flexDirection:"column",overflow:"hidden"};
  const chip=(sel)=>({padding:"10px 16px",border:"none",borderRadius:10,background:sel?"#64dfdf22":"transparent",outline:sel?"1.5px solid #64dfdf66":"1.5px solid #2a2a42",color:sel?"#64dfdf":"#7a7a8a",fontSize:15,fontWeight:sel?600:400,cursor:"pointer"});

  return(
    <div style={ctr}><div style={card}>

      {/* SETUP */}
      {phase==="setup"&&(
        <div style={{textAlign:"center",animation:"slideUp .6s ease",overflowY:"auto",flex:1,paddingBottom:20}}>
          <div style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:4,marginBottom:16}}>STILLNOVA STUDIO</div>
          <h1 style={{fontSize:28,color:"#e8e8f0",fontWeight:700,marginBottom:24}}>Brain Story 5sec</h1>
          <div style={{background:"#1a1a2e",borderRadius:16,padding:20,border:"1px solid #2a2a42",textAlign:"left"}}>
            <div style={{...mf,fontSize:12,color:"#64dfdf",marginBottom:10}}>API KEY</div>
            <p style={{fontSize:14,color:"#7a7a8a",lineHeight:1.7,marginBottom:12}}>Claude APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="password" value={keyIn} onChange={e=>setKeyIn(e.target.value)} placeholder="sk-ant-..."
              style={{width:"100%",padding:"14px 16px",background:"#12122a",border:"1.5px solid #2a2a42",borderRadius:12,color:"#d4d4e0",fontSize:16,marginBottom:12}}/>
            <button onClick={saveKey} style={{width:"100%",padding:16,border:"none",borderRadius:14,background:keyIn.trim()?"linear-gradient(135deg,#64dfdf,#4ab8b8)":"#2a2a42",color:keyIn.trim()?"#0d0d1a":"#5a5a6a",fontSize:16,fontWeight:700,cursor:keyIn.trim()?"pointer":"default"}}>ã¯ã˜ã‚ã‚‹</button>
          </div>
        </div>
      )}

      {/* TITLE */}
      {phase==="title"&&(
        <div style={{textAlign:"center",animation:"slideUp .6s ease",overflowY:"auto",flex:1,paddingBottom:20}}>
          <div style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:4,marginBottom:10}}>STILLNOVA STUDIO</div>
          <h1 style={{fontSize:28,color:"#e8e8f0",fontWeight:700,marginBottom:2}}>Brain Story</h1>
          <div style={{...mf,fontSize:22,color:"#ffd166",marginBottom:6,letterSpacing:2}}>5<span style={{fontSize:14,verticalAlign:"super"}}>sec</span></div>
          <p style={{fontSize:14,color:"#7a7a8a",lineHeight:1.7,marginBottom:14}}>çŠ¶æ³ã‚’èã„ã¦ã€5ç§’ã§åˆ¤æ–­ã€‚<br/>ã‚ãªãŸã®è¨€è‘‰ã§ç‰©èªãŒå‹•ãã€‚</p>

          <div style={{background:"#1a1a2e",borderRadius:16,padding:14,marginBottom:8,border:"1px solid #2a2a42",textAlign:"left"}}>
            <div style={{...mf,fontSize:12,color:"#64dfdf",marginBottom:8}}>ä¸»äººå…¬</div>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
              {PS.map(p=><button key={p.id} onClick={()=>setSp(p.id)} style={chip(sp===p.id)}>{p.l}</button>)}
            </div>
          </div>
          <div style={{background:"#1a1a2e",borderRadius:16,padding:14,marginBottom:8,border:"1px solid #2a2a42",textAlign:"left"}}>
            <div style={{...mf,fontSize:12,color:"#64dfdf",marginBottom:8}}>ã‚¸ãƒ£ãƒ³ãƒ«</div>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
              {GS.map(g=><button key={g.id} onClick={()=>setSg(g.id)} style={chip(sg===g.id)}>{g.l}</button>)}
            </div>
          </div>
          <div style={{background:"#1a1a2e",borderRadius:16,padding:14,marginBottom:14,border:"1px solid #2a2a42",textAlign:"left"}}>
            <div style={{...mf,fontSize:12,color:"#64dfdf",marginBottom:8}}>æ°—åˆ†</div>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
              {MS.map(m=><button key={m.id} onClick={()=>setSm(m.id)} style={chip(sm===m.id)}>{m.l}</button>)}
            </div>
          </div>
          <button onClick={genStory} disabled={gen}
            style={{width:"100%",padding:16,border:"none",borderRadius:14,background:gen?"#2a2a42":"linear-gradient(135deg,#ffd166,#ffb347)",color:gen?"#5a5a6a":"#0d0d1a",fontSize:17,fontWeight:700,cursor:gen?"default":"pointer",marginBottom:8}}>
            {gen?"ç”Ÿæˆä¸­...":"ç‰©èªã‚’ã¯ã˜ã‚ã‚‹"}
          </button>
          <p style={{fontSize:13,color:"#5a5a6a",marginBottom:4}}>æ¯å›AIãŒé•ã†ç‰©èªã‚’ä½œã‚Šã¾ã™</p>
          <button onClick={()=>{localStorage.removeItem("bs5_key");setApiKey("");setPhase("setup")}} style={{background:"none",border:"none",color:"#3a3a52",fontSize:12,cursor:"pointer"}}>APIã‚­ãƒ¼ã‚’å¤‰æ›´</button>
        </div>
      )}

      {/* PLAYING */}
      {phase==="playing"&&sc&&(
        <>
          <div style={{marginBottom:8,flexShrink:0,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <span style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:2}}>{sc.genre} â€” {sc.title}</span>
            <span style={{...mf,fontSize:12,color:"#5a5a6a"}}>SCENE {scenes.filter(s=>s.type==="scene").length}</span>
          </div>

          <div ref={sRef} style={{flex:1,overflowY:"auto",marginBottom:8,paddingRight:4,minHeight:0}}>
            {scenes.map((s,i)=>(
              <div key={i} style={{marginBottom:14,animation:i===scenes.length-1?"slideUp .4s ease":"none"}}>
                {s.type==="scene"?(
                  <div>
                    {s.situation&&<div style={{fontSize:13,color:"#64dfdf88",marginBottom:4,...mf}}>{s.situation}</div>}
                    <p style={{fontSize:17,color:"#e0e0ec",lineHeight:1.9,whiteSpace:"pre-wrap"}}>{s.text}</p>
                  </div>
                ):(
                  <div style={{padding:"10px 14px",marginLeft:16,background:"#64dfdf10",border:"1px solid #64dfdf33",borderRadius:12}}>
                    <p style={{fontSize:16,color:"#e8e8f0",lineHeight:1.6}}>{s.text}</p>
                  </div>
                )}
              </div>
            ))}
            {loading&&(
              <div style={{padding:"12px 0",display:"flex",alignItems:"center",gap:8}}>
                <div style={{display:"flex",gap:4}}>
                  {[0,1,2].map(i=><div key={i} style={{width:7,height:7,borderRadius:"50%",background:"#64dfdf",animation:`breathe 1.2s ${i*.3}s infinite`}}/>)}
                </div>
                <span style={{fontSize:14,color:"#5a5a6a"}}>å±•é–‹ä¸­...</span>
              </div>
            )}
          </div>

          {/* INPUT AREA */}
          {!ending?(
            <div style={{flexShrink:0,paddingBottom:8}}>

              {/* 5ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä¸­ã®è¡¨ç¤º */}
              {challenging&&(
                <div style={{marginBottom:8}}>
                  <div style={{height:5,background:"#2a2a42",borderRadius:3,overflow:"hidden",marginBottom:6}}>
                    <div style={{height:"100%",background:"linear-gradient(90deg,#ffd166,#ff4757)",animation:"countdown5 5s linear forwards",borderRadius:3}}/>
                  </div>
                  <div style={{textAlign:"center",display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>
                    <span style={{fontSize:22,animation:"pulse .6s infinite"}}>ğŸ¤</span>
                    <span style={{fontSize:16,color:"#ffd166",fontWeight:600}}>5ç§’ä»¥å†…ã«å£°ã§ç­”ãˆã¦ï¼</span>
                  </div>
                  {uIn&&<p style={{fontSize:15,color:"#e0e0ec",textAlign:"center",marginTop:6}}>ã€Œ{uIn}ã€</p>}
                </div>
              )}

              {/* é€šå¸¸ã®å…¥åŠ›ã‚¨ãƒªã‚¢ */}
              {!challenging&&!loading&&(
                <>
                  <button onClick={startChallenge}
                    style={{width:"100%",padding:14,border:"none",borderRadius:14,background:"linear-gradient(135deg,#ffd166,#ffb347)",color:"#0d0d1a",fontSize:17,fontWeight:700,cursor:"pointer",marginBottom:8,letterSpacing:1}}>
                    ğŸ¤ 5ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼
                  </button>
                  <div style={{display:"flex",gap:6,alignItems:"center"}}>
                    <button onClick={listening?stopRec:manualMic}
                      style={{width:44,height:44,border:"none",borderRadius:12,background:listening?"linear-gradient(135deg,#ff4757,#ff6b6b)":"#1e1e32",color:listening?"#fff":"#6a6a7a",fontSize:18,cursor:"pointer",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",animation:listening?"pulse 1s infinite":"none"}}>ğŸ¤</button>
                    <input ref={iRef} type="text" value={uIn} onChange={e=>setUIn(e.target.value)} onKeyDown={onKey}
                      placeholder="ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›ã‚‚OK" disabled={loading}
                      style={{flex:1,padding:"10px 14px",background:"#1a1a2e",border:"1.5px solid #2a2a42",borderRadius:12,color:"#d4d4e0",fontSize:16,lineHeight:1.4}}/>
                    <button onClick={manualSubmit} disabled={!uIn.trim()||loading}
                      style={{padding:"10px 14px",border:"none",borderRadius:12,background:uIn.trim()?"linear-gradient(135deg,#64dfdf,#4ab8b8)":"#2a2a42",color:uIn.trim()?"#0d0d1a":"#5a5a6a",fontSize:15,fontWeight:700,cursor:uIn.trim()?"pointer":"default",flexShrink:0,height:44}}>â†’</button>
                  </div>
                </>
              )}
            </div>
          ):(
            <div style={{flexShrink:0,animation:"slideUp .5s ease",paddingBottom:8}}>
              <div style={{background:"#1a1a2e",borderRadius:14,padding:14,border:"1px solid #64dfdf33",marginBottom:10}}>
                <div style={{...mf,fontSize:11,color:"#64dfdf",letterSpacing:3,marginBottom:6}}>ENDING</div>
                <div style={{fontSize:20,color:"#e8e8f0",fontWeight:700,marginBottom:8,lineHeight:1.4}}>{ending.title}</div>
                <p style={{fontSize:15,color:"#a0a0b0",lineHeight:1.8}}>{ending.summary}</p>
                {total>0&&(
                  <div style={{marginTop:10,padding:"8px 12px",background:"#12122a",borderRadius:10,textAlign:"center"}}>
                    <span style={{...mf,fontSize:15,color:"#ffd166"}}>å³æ–­ {fast}/{total}</span>
                  </div>
                )}
              </div>
              <div style={{display:"flex",gap:8}}>
                <button onClick={()=>{stopRec();fade();setPhase("ending")}} style={{flex:1,padding:14,border:"none",borderRadius:14,background:"linear-gradient(135deg,#64dfdf,#4ab8b8)",color:"#0d0d1a",fontSize:15,fontWeight:700,cursor:"pointer"}}>æŒ¯ã‚Šè¿”ã‚Š</button>
                <button onClick={()=>{stopRec();fade();setPhase("title")}} style={{flex:1,padding:14,border:"1.5px solid #3a3a52",borderRadius:14,background:"transparent",color:"#8a8a9a",fontSize:15,cursor:"pointer"}}>æ¬¡ã®ç‰©èª</button>
              </div>
            </div>
          )}
        </>
      )}

      {/* ENDING DETAIL */}
      {phase==="ending"&&ending&&sc&&(
        <div style={{animation:"slideUp .6s ease",overflowY:"auto",flex:1,paddingBottom:20}}>
          <div style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:3,marginBottom:20,textAlign:"center"}}>ENDING</div>
          <div style={{fontSize:24,color:"#e8e8f0",fontWeight:700,marginBottom:16,lineHeight:1.4,textAlign:"center"}}>{ending.title}</div>
          <p style={{fontSize:16,color:"#a0a0b0",lineHeight:2,marginBottom:16}}>{ending.summary}</p>

          {total>0&&(
            <div style={{background:"#1a1a2e",borderRadius:14,padding:16,marginBottom:16,border:"1px solid #ffd16633",textAlign:"center"}}>
              <div style={{...mf,fontSize:12,color:"#ffd166",marginBottom:8}}>5SEC CHALLENGE</div>
              <div style={{fontSize:36,color:"#ffd166",fontWeight:700,...mf}}>{fast}/{total}</div>
              <p style={{fontSize:14,color:"#7a7a8a",marginTop:4}}>å›ã®å³æ–­ã«æˆåŠŸ</p>
            </div>
          )}

          <div style={{background:"#1a1a2e",borderRadius:14,padding:16,marginBottom:14,border:"1px solid #2a2a42",maxHeight:350,overflowY:"auto"}}>
            <div style={{...mf,fontSize:12,color:"#64dfdf",letterSpacing:2,marginBottom:12}}>FULL STORY</div>
            <p style={{fontSize:15,color:"#8a8a9a",lineHeight:1.8,marginBottom:10,whiteSpace:"pre-wrap"}}>{sc.firstScene}</p>
            {scenes.slice(1).map((s,i)=>(
              <div key={i} style={{marginBottom:10}}>
                {s.type==="action"?(
                  <div style={{padding:"6px 10px",marginLeft:12,background:"#64dfdf08",border:"1px solid #64dfdf22",borderRadius:8}}>
                    <span style={{fontSize:14,color:"#c4c4d0"}}>{s.text}</span>
                  </div>
                ):(
                  <p style={{fontSize:14,color:"#8a8a9a",lineHeight:1.8,whiteSpace:"pre-wrap"}}>{s.text}</p>
                )}
              </div>
            ))}
          </div>

          <div style={{background:"#1a1a2e",borderRadius:14,padding:16,marginBottom:16,border:"1px solid #2a2a42"}}>
            <div style={{...mf,fontSize:12,color:"#ffd166",letterSpacing:2,marginBottom:10}}>YOUR ACTIONS</div>
            {aLog.map((a,i)=>(
              <div key={i} style={{display:"flex",gap:10,padding:"6px 0",borderBottom:i<aLog.length-1?"1px solid #22223a":"none"}}>
                <span style={{...mf,fontSize:12,color:"#5a5a6a",width:20,flexShrink:0}}>{i+1}</span>
                <span style={{fontSize:14,color:"#a0a0b0",lineHeight:1.6}}>{a}</span>
              </div>
            ))}
          </div>

          <button onClick={()=>{fade();setPhase("title")}} style={{width:"100%",padding:16,border:"none",borderRadius:14,background:"linear-gradient(135deg,#ffd166,#ffb347)",color:"#0d0d1a",fontSize:17,fontWeight:700,cursor:"pointer",marginBottom:8}}>æ–°ã—ã„ç‰©èªã‚’ã¯ã˜ã‚ã‚‹</button>
        </div>
      )}

    </div></div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
